<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¿èªç®¡ç† - sunyuTECH-DX</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #E8E4DF;
      color: #2D2D2D;
      min-height: 100vh;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(255,255,255,0.8);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      font-size: 13px;
      color: rgba(0,0,0,0.7);
      cursor: pointer;
      text-decoration: none;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      color: #1D1D1F;
    }

    .user-badge {
      padding: 8px 16px;
      background: #0a2540;
      border-radius: 50px;
      font-size: 13px;
      color: #fff;
      font-weight: 600;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* ã‚¿ãƒ– */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .tab-btn {
      padding: 12px 24px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      font-size: 14px;
      font-weight: 500;
      color: rgba(0,0,0,0.6);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab-btn:hover {
      background: rgba(0,0,0,0.02);
    }

    .tab-btn.active {
      background: #0a2540;
      border-color: #0a2540;
      color: #fff;
    }

    .tab-badge {
      padding: 2px 8px;
      background: rgba(255,107,0,0.2);
      border-radius: 10px;
      font-size: 12px;
      color: #FF6B00;
    }

    .tab-btn.active .tab-badge {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .approval-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    /* æ‰¿èªå¾…ã¡ãƒªã‚¹ãƒˆ */
    .approval-list-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .approval-list-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .approval-list-title {
      font-size: 16px;
      font-weight: 600;
    }

    .approval-list {
      max-height: calc(100vh - 320px);
      overflow-y: auto;
    }

    .approval-item {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s;
    }

    .approval-item:hover {
      background: rgba(255,107,0,0.02);
    }

    .approval-item.selected {
      background: rgba(255,107,0,0.05);
      border-left: 3px solid #FF6B00;
    }

    .approval-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .approval-project-code {
      font-family: 'SF Mono', monospace;
      font-size: 12px;
      color: #FF6B00;
    }

    .approval-stage-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
    }

    .approval-stage-badge.pending_manager {
      background: rgba(245,158,11,0.1);
      color: #f59e0b;
    }

    .approval-stage-badge.pending_executive {
      background: rgba(139,92,246,0.1);
      color: #8b5cf6;
    }

    .approval-project-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .approval-client-name {
      font-size: 13px;
      color: rgba(0,0,0,0.5);
      margin-bottom: 12px;
    }

    .approval-meta {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: rgba(0,0,0,0.4);
    }

    .approval-amount {
      font-weight: 600;
      color: rgba(0,0,0,0.7);
    }

    /* è©³ç´°ãƒ‘ãƒãƒ« */
    .detail-panel {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      position: sticky;
      top: 100px;
    }

    .detail-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-title {
      font-size: 16px;
      font-weight: 600;
    }

    .detail-body {
      padding: 24px;
    }

    .detail-section {
      margin-bottom: 24px;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section-title {
      font-size: 12px;
      font-weight: 600;
      color: rgba(0,0,0,0.4);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .detail-info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .detail-info-row:last-child {
      border-bottom: none;
    }

    .detail-info-label {
      color: rgba(0,0,0,0.5);
      font-size: 13px;
    }

    .detail-info-value {
      font-weight: 500;
      font-size: 14px;
    }

    .detail-info-value.highlight {
      color: #FF6B00;
      font-size: 18px;
      font-weight: 700;
    }

    .profit-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .profit-badge.good {
      background: rgba(16,185,129,0.1);
      color: #10b981;
    }

    .profit-badge.warning {
      background: rgba(245,158,11,0.1);
      color: #f59e0b;
    }

    .profit-badge.danger {
      background: rgba(239,68,68,0.1);
      color: #ef4444;
    }

    /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
    .timeline {
      position: relative;
      padding-left: 24px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(0,0,0,0.1);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item:last-child {
      padding-bottom: 0;
    }

    .timeline-dot {
      position: absolute;
      left: -20px;
      top: 0;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .timeline-dot.requested { border-color: #3b82f6; background: rgba(59,130,246,0.1); }
    .timeline-dot.approved { border-color: #10b981; background: rgba(16,185,129,0.1); }
    .timeline-dot.rejected { border-color: #ef4444; background: rgba(239,68,68,0.1); }
    .timeline-dot.pending { border-color: #f59e0b; background: rgba(245,158,11,0.1); }

    .timeline-content {
      background: rgba(0,0,0,0.02);
      border-radius: 8px;
      padding: 12px;
    }

    .timeline-action {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .timeline-user {
      font-size: 12px;
      color: rgba(0,0,0,0.5);
    }

    .timeline-date {
      font-size: 11px;
      color: rgba(0,0,0,0.4);
      margin-top: 4px;
    }

    .timeline-comment {
      margin-top: 8px;
      padding: 8px 12px;
      background: #fff;
      border-radius: 6px;
      font-size: 13px;
      color: rgba(0,0,0,0.7);
      border-left: 3px solid #FF6B00;
    }

    /* ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ› */
    .comment-input {
      width: 100%;
      padding: 12px;
      background: rgba(0,0,0,0.03);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 16px;
    }

    .comment-input:focus {
      outline: none;
      border-color: #FF6B00;
      background: #fff;
    }

    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-buttons {
      display: flex;
      gap: 12px;
    }

    .btn-approve {
      flex: 1;
      padding: 14px 24px;
      background: linear-gradient(135deg, #10b981, #059669);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-approve:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16,185,129,0.3);
    }

    .btn-reject {
      flex: 1;
      padding: 14px 24px;
      background: transparent;
      border: 1px solid #ef4444;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #ef4444;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-reject:hover {
      background: rgba(239,68,68,0.05);
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-detail {
      text-align: center;
      padding: 60px 20px;
      color: rgba(0,0,0,0.4);
    }

    .empty-detail-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-detail-title {
      font-size: 16px;
      font-weight: 500;
      color: rgba(0,0,0,0.5);
    }

    /* ãƒãƒŠãƒ¼ */
    .banner {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 16px 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: top 0.3s ease;
    }

    .banner.show {
      top: 20px;
    }

    .banner.success {
      background: #d1fae5;
      border: 1px solid #22c55e;
      color: #065f46;
    }

    .banner.error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1024px) {
      .approval-layout {
        grid-template-columns: 1fr;
      }

      .detail-panel {
        position: static;
      }
    }

    @media (max-width: 768px) {
      .tabs {
        flex-wrap: wrap;
      }

      .tab-btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒãƒŠãƒ¼ -->
  <div class="banner success" id="successBanner">
    <span>âœ…</span>
    <span id="successMessage">æ‰¿èªã—ã¾ã—ãŸ</span>
  </div>

  <div class="banner error" id="errorBanner">
    <span>âš ï¸</span>
    <span id="errorMessage">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="page-header">
    <div class="header-left">
      <a href="budget-list.html" class="back-btn">â† å®Ÿè¡Œäºˆç®—ä¸€è¦§</a>
      <h1 class="page-title">æ‰¿èªç®¡ç†</h1>
    </div>
    <div class="user-badge">å±±ç”°éƒ¨é•·</div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="pending_manager">
        éƒ¨é•·æ‰¿èªå¾…ã¡
        <span class="tab-badge" id="managerCount">3</span>
      </button>
      <button class="tab-btn" data-tab="pending_executive">
        å½¹å“¡æ‰¿èªå¾…ã¡
        <span class="tab-badge" id="executiveCount">2</span>
      </button>
      <button class="tab-btn" data-tab="approved">
        æ‰¿èªæ¸ˆã¿
      </button>
      <button class="tab-btn" data-tab="rejected">
        å´ä¸‹
      </button>
    </div>

    <!-- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
    <div class="approval-layout">
      <!-- æ‰¿èªå¾…ã¡ãƒªã‚¹ãƒˆ -->
      <div class="approval-list-card">
        <div class="approval-list-header">
          <h2 class="approval-list-title">æ‰¿èªå¾…ã¡æ¡ˆä»¶</h2>
        </div>
        <div class="approval-list" id="approvalList">
          <!-- å‹•çš„ã«æŒ¿å…¥ -->
        </div>
      </div>

      <!-- è©³ç´°ãƒ‘ãƒãƒ« -->
      <div class="detail-panel">
        <div class="detail-header">
          <h3 class="detail-title">æ¡ˆä»¶è©³ç´°</h3>
        </div>
        <div class="detail-body" id="detailBody">
          <div class="empty-detail">
            <div class="empty-detail-icon">ğŸ“‹</div>
            <div class="empty-detail-title">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let approvalData = [];
    let currentTab = 'pending_manager';
    let selectedId = null;

    // XSSå¯¾ç­–
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatAmount(num) {
      return Math.floor(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDateTime(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    function generateSampleData() {
      return [
        {
          id: 1,
          budget_id: 1,
          project_code: '2026-001',
          project_name: 'é•·å´è‡ªå‹•è»Šé“èˆ—è£…è£œä¿®å·¥äº‹',
          client_name: 'NEXCOè¥¿æ—¥æœ¬',
          estimate_amount: 12500000,
          budget_amount: 9800000,
          profit_rate: 21.6,
          status: 'pending_manager',
          requested_by: { id: 1, name: 'ãŸã', role: 'sales' },
          requested_at: '2026-01-11T10:00:00Z',
          request_comment: 'ç²—åˆ©ç‡21.6%ã§å•é¡Œãªã„ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚æ—©ã‚ã®æ‰¿èªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚',
          history: [
            {
              action: 'requested',
              user: { id: 1, name: 'ãŸã' },
              timestamp: '2026-01-11T10:00:00Z',
              comment: 'æ‰¿èªç”³è«‹ã—ã¾ã—ãŸ'
            }
          ]
        },
        {
          id: 2,
          budget_id: 2,
          project_code: '2026-002',
          project_name: 'ç¦å²¡ç’°çŠ¶ç·šæ©‹æ¢ç‚¹æ¤œæ¥­å‹™',
          client_name: 'ç¦å²¡å¸‚é“è·¯ç®¡ç†èª²',
          estimate_amount: 8500000,
          budget_amount: 6800000,
          profit_rate: 20.0,
          status: 'pending_manager',
          requested_by: { id: 2, name: 'å±±ç”°', role: 'sales' },
          requested_at: '2026-01-10T15:30:00Z',
          request_comment: 'å‰å›åŒæ§˜ã®æ¡ä»¶ã§ã™ã€‚',
          history: [
            {
              action: 'requested',
              user: { id: 2, name: 'å±±ç”°' },
              timestamp: '2026-01-10T15:30:00Z',
              comment: 'æ‰¿èªç”³è«‹ã—ã¾ã—ãŸ'
            }
          ]
        },
        {
          id: 3,
          budget_id: 3,
          project_code: '2026-003',
          project_name: 'åŒ—ä¹å·èˆ—è£…å·¥äº‹',
          client_name: 'NEXCOä¹å·',
          estimate_amount: 25000000,
          budget_amount: 20000000,
          profit_rate: 20.0,
          status: 'pending_manager',
          requested_by: { id: 1, name: 'ãŸã', role: 'sales' },
          requested_at: '2026-01-09T09:00:00Z',
          request_comment: 'å¤§å‹æ¡ˆä»¶ã®ãŸã‚æ…é‡ã«æ¤œè¨ã—ã¾ã—ãŸã€‚',
          history: [
            {
              action: 'requested',
              user: { id: 1, name: 'ãŸã' },
              timestamp: '2026-01-09T09:00:00Z',
              comment: 'æ‰¿èªç”³è«‹ã—ã¾ã—ãŸ'
            }
          ]
        },
        {
          id: 4,
          budget_id: 4,
          project_code: '2026-004',
          project_name: 'ç†Šæœ¬çœŒé“æ•´å‚™å·¥äº‹',
          client_name: 'ç†Šæœ¬çœŒåœŸæœ¨éƒ¨',
          estimate_amount: 15000000,
          budget_amount: 11500000,
          profit_rate: 23.3,
          status: 'pending_executive',
          requested_by: { id: 1, name: 'ãŸã', role: 'sales' },
          requested_at: '2026-01-08T14:00:00Z',
          request_comment: '',
          manager_approver: { id: 3, name: 'å±±ç”°éƒ¨é•·', role: 'manager' },
          manager_approved_at: '2026-01-09T10:00:00Z',
          manager_comment: 'å†…å®¹ç¢ºèªã—ã¾ã—ãŸã€‚å½¹å“¡æ‰¿èªã¸å›ã—ã¾ã™ã€‚',
          history: [
            {
              action: 'requested',
              user: { id: 1, name: 'ãŸã' },
              timestamp: '2026-01-08T14:00:00Z',
              comment: 'æ‰¿èªç”³è«‹ã—ã¾ã—ãŸ'
            },
            {
              action: 'approved',
              user: { id: 3, name: 'å±±ç”°éƒ¨é•·' },
              timestamp: '2026-01-09T10:00:00Z',
              comment: 'å†…å®¹ç¢ºèªã—ã¾ã—ãŸã€‚å½¹å“¡æ‰¿èªã¸å›ã—ã¾ã™ã€‚'
            }
          ]
        },
        {
          id: 5,
          budget_id: 5,
          project_code: '2026-005',
          project_name: 'ä½è³€ç©ºæ¸¯æ»‘èµ°è·¯è£œä¿®',
          client_name: 'ä½è³€çœŒç©ºæ¸¯ç®¡ç†èª²',
          estimate_amount: 45000000,
          budget_amount: 35000000,
          profit_rate: 22.2,
          status: 'pending_executive',
          requested_by: { id: 2, name: 'å±±ç”°', role: 'sales' },
          requested_at: '2026-01-07T11:00:00Z',
          request_comment: 'ç©ºæ¸¯æ¡ˆä»¶ã®ãŸã‚ç‰¹åˆ¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚',
          manager_approver: { id: 3, name: 'å±±ç”°éƒ¨é•·', role: 'manager' },
          manager_approved_at: '2026-01-08T09:00:00Z',
          manager_comment: 'å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚',
          history: [
            {
              action: 'requested',
              user: { id: 2, name: 'å±±ç”°' },
              timestamp: '2026-01-07T11:00:00Z',
              comment: 'ç©ºæ¸¯æ¡ˆä»¶ã®ãŸã‚ç‰¹åˆ¥å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚'
            },
            {
              action: 'approved',
              user: { id: 3, name: 'å±±ç”°éƒ¨é•·' },
              timestamp: '2026-01-08T09:00:00Z',
              comment: 'å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚'
            }
          ]
        }
      ];
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      approvalData = generateSampleData();
      updateCounts();
      renderList();
      setupTabs();
    });

    // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
    function updateCounts() {
      const managerCount = approvalData.filter(a => a.status === 'pending_manager').length;
      const executiveCount = approvalData.filter(a => a.status === 'pending_executive').length;
      document.getElementById('managerCount').textContent = managerCount;
      document.getElementById('executiveCount').textContent = executiveCount;
    }

    // ãƒªã‚¹ãƒˆæç”»
    function renderList() {
      const list = document.getElementById('approvalList');
      const filtered = approvalData.filter(a => a.status === currentTab);

      if (filtered.length === 0) {
        list.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: rgba(0,0,0,0.4);">
            <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
            <div>æ‰¿èªå¾…ã¡ã®æ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“</div>
          </div>
        `;
        return;
      }

      list.innerHTML = filtered.map(item => {
        const stageLabels = {
          pending_manager: 'éƒ¨é•·æ‰¿èªå¾…ã¡',
          pending_executive: 'å½¹å“¡æ‰¿èªå¾…ã¡'
        };

        return `
          <div class="approval-item ${selectedId === item.id ? 'selected' : ''}"
               onclick="selectItem(${item.id})">
            <div class="approval-item-header">
              <span class="approval-project-code">${escapeHtml(item.project_code)}</span>
              <span class="approval-stage-badge ${item.status}">
                ${stageLabels[item.status] || ''}
              </span>
            </div>
            <div class="approval-project-name">${escapeHtml(item.project_name)}</div>
            <div class="approval-client-name">${escapeHtml(item.client_name)}</div>
            <div class="approval-meta">
              <span class="approval-amount">Â¥${formatAmount(item.estimate_amount)}</span>
              <span>ç²—åˆ©ç‡ ${item.profit_rate}%</span>
              <span>ç”³è«‹: ${escapeHtml(item.requested_by.name)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    // ã‚¿ãƒ–è¨­å®š
    function setupTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentTab = btn.dataset.tab;
          selectedId = null;
          renderList();
          renderDetail();
        });
      });
    }

    // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ
    function selectItem(id) {
      selectedId = id;
      renderList();
      renderDetail();
    }

    // è©³ç´°æç”»
    function renderDetail() {
      const detailBody = document.getElementById('detailBody');

      if (!selectedId) {
        detailBody.innerHTML = `
          <div class="empty-detail">
            <div class="empty-detail-icon">ğŸ“‹</div>
            <div class="empty-detail-title">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
        `;
        return;
      }

      const item = approvalData.find(a => a.id === selectedId);
      if (!item) return;

      const profitClass = item.profit_rate >= 20 ? 'good'
        : item.profit_rate >= 10 ? 'warning'
        : 'danger';

      detailBody.innerHTML = `
        <div class="detail-section">
          <div class="detail-section-title">æ¡ˆä»¶æƒ…å ±</div>
          <div class="detail-info-row">
            <span class="detail-info-label">æ¡ˆä»¶ç•ªå·</span>
            <span class="detail-info-value">${escapeHtml(item.project_code)}</span>
          </div>
          <div class="detail-info-row">
            <span class="detail-info-label">æ¡ˆä»¶å</span>
            <span class="detail-info-value">${escapeHtml(item.project_name)}</span>
          </div>
          <div class="detail-info-row">
            <span class="detail-info-label">é¡§å®¢å</span>
            <span class="detail-info-value">${escapeHtml(item.client_name)}</span>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-section-title">é‡‘é¡æƒ…å ±</div>
          <div class="detail-info-row">
            <span class="detail-info-label">è¦‹ç©é‡‘é¡</span>
            <span class="detail-info-value highlight">Â¥${formatAmount(item.estimate_amount)}</span>
          </div>
          <div class="detail-info-row">
            <span class="detail-info-label">å®Ÿè¡Œäºˆç®—é¡</span>
            <span class="detail-info-value">Â¥${formatAmount(item.budget_amount)}</span>
          </div>
          <div class="detail-info-row">
            <span class="detail-info-label">ç²—åˆ©ç‡</span>
            <span class="profit-badge ${profitClass}">${item.profit_rate}%</span>
          </div>
        </div>

        <div class="detail-section">
          <div class="detail-section-title">æ‰¿èªå±¥æ­´</div>
          <div class="timeline">
            ${item.history.map(h => {
              const actionLabels = {
                requested: 'ğŸ“ æ‰¿èªç”³è«‹',
                approved: 'âœ… æ‰¿èª',
                rejected: 'âŒ å´ä¸‹'
              };
              return `
                <div class="timeline-item">
                  <div class="timeline-dot ${h.action}"></div>
                  <div class="timeline-content">
                    <div class="timeline-action">${actionLabels[h.action] || h.action}</div>
                    <div class="timeline-user">${escapeHtml(h.user.name)}</div>
                    <div class="timeline-date">${formatDateTime(h.timestamp)}</div>
                    ${h.comment ? `<div class="timeline-comment">${escapeHtml(h.comment)}</div>` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>

        ${(item.status === 'pending_manager' || item.status === 'pending_executive') ? `
          <div class="detail-section">
            <div class="detail-section-title">æ‰¿èªã‚³ãƒ¡ãƒ³ãƒˆ</div>
            <textarea class="comment-input" id="approvalComment" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ï¼ˆä»»æ„ï¼‰"></textarea>
            <div class="action-buttons">
              <button class="btn-approve" onclick="approveItem(${item.id})">
                âœ… æ‰¿èªã™ã‚‹
              </button>
              <button class="btn-reject" onclick="rejectItem(${item.id})">
                âŒ å´ä¸‹ã™ã‚‹
              </button>
            </div>
          </div>
        ` : ''}
      `;
    }

    // æ‰¿èª
    function approveItem(id) {
      const comment = document.getElementById('approvalComment')?.value || '';
      const item = approvalData.find(a => a.id === id);
      if (!item) return;

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      if (item.status === 'pending_manager') {
        item.status = 'pending_executive';
        item.manager_approved_at = new Date().toISOString();
        item.manager_comment = comment;
      } else if (item.status === 'pending_executive') {
        item.status = 'approved';
        item.executive_approved_at = new Date().toISOString();
        item.executive_comment = comment;
      }

      // å±¥æ­´è¿½åŠ 
      item.history.push({
        action: 'approved',
        user: { id: 3, name: 'å±±ç”°éƒ¨é•·' },
        timestamp: new Date().toISOString(),
        comment: comment || 'æ‰¿èªã—ã¾ã—ãŸ'
      });

      selectedId = null;
      updateCounts();
      renderList();
      renderDetail();
      showBanner('success', 'æ‰¿èªã—ã¾ã—ãŸ');
    }

    // å´ä¸‹
    function rejectItem(id) {
      const comment = document.getElementById('approvalComment')?.value || '';
      if (!comment) {
        showBanner('error', 'å´ä¸‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const item = approvalData.find(a => a.id === id);
      if (!item) return;

      item.status = 'rejected';
      item.history.push({
        action: 'rejected',
        user: { id: 3, name: 'å±±ç”°éƒ¨é•·' },
        timestamp: new Date().toISOString(),
        comment: comment
      });

      selectedId = null;
      updateCounts();
      renderList();
      renderDetail();
      showBanner('success', 'å´ä¸‹ã—ã¾ã—ãŸ');
    }

    // ãƒãƒŠãƒ¼è¡¨ç¤º
    function showBanner(type, message) {
      const banner = document.getElementById(type === 'success' ? 'successBanner' : 'errorBanner');
      const msgEl = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
      msgEl.textContent = message;
      banner.classList.add('show');
      setTimeout(() => {
        banner.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
