<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®Ÿè¡Œäºˆç®—ä¸€è¦§ - sunyuTECH-DX</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #E8E4DF;
      color: #2D2D2D;
      min-height: 100vh;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(255,255,255,0.8);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      font-size: 13px;
      color: rgba(0,0,0,0.7);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .back-btn:hover {
      background: rgba(0,0,0,0.08);
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      color: #1D1D1F;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-primary {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #FF6B00, #FF8C00);
      border: none;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(255,107,0,0.3);
      text-decoration: none;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,107,0,0.4);
    }

    .user-badge {
      padding: 8px 16px;
      background: #0a2540;
      border-radius: 50px;
      font-size: 13px;
      color: #fff;
      font-weight: 600;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
      padding: 24px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-card {
      background: #fff;
      border-radius: 16px;
      padding: 20px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .summary-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-bottom: 12px;
    }

    .summary-icon.projects { background: rgba(59,130,246,0.1); }
    .summary-icon.estimate { background: rgba(255,107,0,0.1); }
    .summary-icon.budget { background: rgba(16,185,129,0.1); }
    .summary-icon.profit { background: rgba(139,92,246,0.1); }

    .summary-label {
      font-size: 12px;
      color: rgba(0,0,0,0.5);
      margin-bottom: 4px;
    }

    .summary-value {
      font-size: 24px;
      font-weight: 700;
      color: #1D1D1F;
    }

    .summary-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      margin-top: 8px;
    }

    .summary-change.positive { color: #10b981; }
    .summary-change.negative { color: #ef4444; }

    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .filter-card {
      background: #fff;
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .filter-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .filter-group label {
      font-size: 12px;
      color: rgba(0,0,0,0.5);
      font-weight: 500;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 14px;
      background: #f5f5f5;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-size: 14px;
      color: #1D1D1F;
      min-width: 160px;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #FF6B00;
      background: #fff;
    }

    .search-input {
      min-width: 280px !important;
    }

    .btn-filter {
      padding: 10px 20px;
      background: #0a2540;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-filter:hover {
      background: #0d3050;
    }

    .btn-clear {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 8px;
      font-size: 14px;
      color: rgba(0,0,0,0.6);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-clear:hover {
      background: rgba(0,0,0,0.05);
    }

    /* ä¸€æ‹¬æ“ä½œãƒãƒ¼ */
    .bulk-actions {
      display: none;
      align-items: center;
      gap: 16px;
      padding: 12px 20px;
      background: #0a2540;
      border-radius: 12px;
      margin-bottom: 16px;
      color: #fff;
    }

    .bulk-actions.show {
      display: flex;
    }

    .bulk-count {
      font-size: 14px;
      font-weight: 500;
    }

    .bulk-buttons {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .btn-bulk {
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      font-size: 13px;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-bulk:hover {
      background: rgba(255,255,255,0.2);
    }

    .btn-bulk.danger:hover {
      background: rgba(239,68,68,0.3);
      border-color: #ef4444;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ */
    .table-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      padding: 14px 16px;
      background: #f9fafb;
      font-size: 12px;
      font-weight: 600;
      color: rgba(0,0,0,0.5);
      text-align: left;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .data-table th.sortable {
      cursor: pointer;
      user-select: none;
    }

    .data-table th.sortable:hover {
      color: #FF6B00;
    }

    .data-table th.sortable::after {
      content: 'â†•';
      margin-left: 4px;
      opacity: 0.3;
    }

    .data-table th.sortable.asc::after {
      content: 'â†‘';
      opacity: 1;
    }

    .data-table th.sortable.desc::after {
      content: 'â†“';
      opacity: 1;
    }

    .data-table td {
      padding: 16px;
      font-size: 14px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      vertical-align: middle;
    }

    .data-table tr:hover {
      background: rgba(255,107,0,0.02);
    }

    .data-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #FF6B00;
    }

    .project-code {
      font-family: 'SF Mono', monospace;
      font-size: 13px;
      color: #FF6B00;
      cursor: pointer;
    }

    .project-code:hover {
      text-decoration: underline;
    }

    .project-name {
      font-weight: 500;
      color: #1D1D1F;
    }

    .client-name {
      color: rgba(0,0,0,0.6);
      font-size: 13px;
    }

    .amount {
      font-weight: 600;
      text-align: right;
      font-family: 'SF Mono', monospace;
    }

    .profit-rate {
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      display: inline-block;
    }

    .profit-rate.high { background: rgba(59,130,246,0.1); color: #3b82f6; }
    .profit-rate.good { background: rgba(16,185,129,0.1); color: #10b981; }
    .profit-rate.warning { background: rgba(245,158,11,0.1); color: #f59e0b; }
    .profit-rate.danger { background: rgba(239,68,68,0.1); color: #ef4444; }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.draft { background: rgba(107,114,128,0.1); color: #6b7280; }
    .status-badge.pending { background: rgba(245,158,11,0.1); color: #f59e0b; }
    .status-badge.approved { background: rgba(16,185,129,0.1); color: #10b981; }
    .status-badge.rejected { background: rgba(239,68,68,0.1); color: #ef4444; }

    .date-cell {
      color: rgba(0,0,0,0.5);
      font-size: 13px;
    }

    .actions-cell {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: rgba(0,0,0,0.05);
    }

    .btn-icon.danger:hover {
      background: rgba(239,68,68,0.1);
    }

    /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
    .pagination-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-top: 1px solid rgba(0,0,0,0.08);
    }

    .pagination-info {
      font-size: 13px;
      color: rgba(0,0,0,0.5);
    }

    .pagination-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pagination-btn {
      padding: 8px 12px;
      background: transparent;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 6px;
      font-size: 13px;
      color: rgba(0,0,0,0.7);
      cursor: pointer;
      transition: all 0.2s;
    }

    .pagination-btn:hover:not(:disabled) {
      background: rgba(0,0,0,0.05);
      border-color: #FF6B00;
      color: #FF6B00;
    }

    .pagination-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .pagination-btn.active {
      background: #FF6B00;
      border-color: #FF6B00;
      color: #fff;
    }

    .per-page-select {
      padding: 8px 12px;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 6px;
      font-size: 13px;
      color: rgba(0,0,0,0.7);
      margin-left: 16px;
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(0,0,0,0.4);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: rgba(0,0,0,0.6);
      margin-bottom: 8px;
    }

    .empty-state-desc {
      font-size: 14px;
      margin-bottom: 24px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 480px;
      width: 90%;
      animation: modalIn 0.2s ease;
    }

    @keyframes modalIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(0,0,0,0.05);
      font-size: 18px;
      cursor: pointer;
    }

    .modal-body {
      margin-bottom: 24px;
      color: rgba(0,0,0,0.7);
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn-cancel {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-danger {
      padding: 10px 20px;
      background: #ef4444;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      cursor: pointer;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1200px) {
      .summary-cards {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }

      .filter-row {
        flex-direction: column;
      }

      .filter-group input,
      .filter-group select {
        width: 100%;
      }

      .table-card {
        overflow-x: auto;
      }

      .data-table {
        min-width: 1000px;
      }

      .page-header {
        flex-wrap: wrap;
        gap: 12px;
      }

      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="page-header">
    <div class="header-left">
      <a href="upload-page.html" class="back-btn">â† å–¶æ¥­éƒ¨å±‹</a>
      <h1 class="page-title">å®Ÿè¡Œäºˆç®—ä¸€è¦§</h1>
    </div>
    <div class="header-actions">
      <a href="upload-page.html" class="btn-primary">+ æ–°è¦ä½œæˆ</a>
      <div class="user-badge">ãŸã</div>
    </div>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="summary-icon projects">ğŸ“Š</div>
        <div class="summary-label">ç·ä»¶æ•°</div>
        <div class="summary-value" id="totalCount">0ä»¶</div>
        <div class="summary-change positive" id="countChange">
          <span>â†‘</span> <span>å‰æœˆæ¯” +5ä»¶</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon estimate">ğŸ’°</div>
        <div class="summary-label">ç·è¦‹ç©é‡‘é¡</div>
        <div class="summary-value" id="totalEstimate">Â¥0</div>
        <div class="summary-change positive" id="estimateChange">
          <span>â†‘</span> <span>+12.5%</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon budget">ğŸ“</div>
        <div class="summary-label">ç·å®Ÿè¡Œäºˆç®—é¡</div>
        <div class="summary-value" id="totalBudget">Â¥0</div>
        <div class="summary-change positive" id="budgetChange">
          <span>â†‘</span> <span>+10.2%</span>
        </div>
      </div>
      <div class="summary-card">
        <div class="summary-icon profit">ğŸ“ˆ</div>
        <div class="summary-label">å¹³å‡ç²—åˆ©ç‡</div>
        <div class="summary-value" id="avgProfitRate">0%</div>
        <div class="summary-change negative" id="profitChange">
          <span>â†“</span> <span>-1.2%</span>
        </div>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="filter-card">
      <div class="filter-row">
        <div class="filter-group">
          <label>æ¤œç´¢</label>
          <input type="text" id="searchInput" class="search-input" placeholder="æ¡ˆä»¶åãƒ»é¡§å®¢åãƒ»æ¡ˆä»¶ç•ªå·">
        </div>
        <div class="filter-group">
          <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="statusFilter">
            <option value="">å…¨ã¦</option>
            <option value="draft">ä¸‹æ›¸ã</option>
            <option value="pending">æ‰¿èªå¾…ã¡</option>
            <option value="approved">æ‰¿èªæ¸ˆã¿</option>
            <option value="rejected">å´ä¸‹</option>
          </select>
        </div>
        <div class="filter-group">
          <label>æœŸé–“</label>
          <select id="periodFilter">
            <option value="">å…¨æœŸé–“</option>
            <option value="this_month">ä»Šæœˆ</option>
            <option value="last_month">å…ˆæœˆ</option>
            <option value="this_quarter">ä»Šå››åŠæœŸ</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ç²—åˆ©ç‡</label>
          <select id="profitFilter">
            <option value="">å…¨ã¦</option>
            <option value="0-10">ã€œ10%</option>
            <option value="10-20">10ã€œ20%</option>
            <option value="20-30">20ã€œ30%</option>
            <option value="30-100">30%ã€œ</option>
          </select>
        </div>
        <button class="btn-filter" onclick="applyFilters()">æ¤œç´¢</button>
        <button class="btn-clear" onclick="clearFilters()">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <!-- ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
    <div class="bulk-actions" id="bulkActions">
      <span class="bulk-count"><span id="selectedCount">0</span>ä»¶é¸æŠä¸­</span>
      <div class="bulk-buttons">
        <button class="btn-bulk" onclick="exportSelected()">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn-bulk danger" onclick="deleteSelected()">å‰Šé™¤</button>
      </div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-card">
      <table class="data-table">
        <thead>
          <tr>
            <th style="width: 40px;">
              <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            </th>
            <th class="sortable" data-sort="project_code">æ¡ˆä»¶ç•ªå·</th>
            <th class="sortable" data-sort="project_name">æ¡ˆä»¶å</th>
            <th class="sortable" data-sort="client_name">é¡§å®¢å</th>
            <th class="sortable" data-sort="estimate_amount">è¦‹ç©é‡‘é¡</th>
            <th class="sortable" data-sort="budget_amount">å®Ÿè¡Œäºˆç®—é¡</th>
            <th class="sortable" data-sort="profit_rate">ç²—åˆ©ç‡</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th class="sortable" data-sort="updated_at">æ›´æ–°æ—¥</th>
            <th style="width: 120px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- å‹•çš„ã«æŒ¿å…¥ -->
        </tbody>
      </table>

      <!-- ç©ºçŠ¶æ…‹ -->
      <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-state-icon">ğŸ“‹</div>
        <div class="empty-state-title">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        <div class="empty-state-desc">æ–°ã—ã„å®Ÿè¡Œäºˆç®—ã‚’ä½œæˆã—ã¦ãã ã•ã„</div>
        <a href="upload-page.html" class="btn-primary">+ æ–°è¦ä½œæˆ</a>
      </div>

      <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="pagination-bar" id="paginationBar">
        <div class="pagination-info" id="paginationInfo">
          1-20 / 45ä»¶
        </div>
        <div class="pagination-controls">
          <button class="pagination-btn" id="prevBtn" onclick="goToPage(currentPage - 1)">â† å‰ã¸</button>
          <div id="pageNumbers"></div>
          <button class="pagination-btn" id="nextBtn" onclick="goToPage(currentPage + 1)">æ¬¡ã¸ â†’</button>
          <select class="per-page-select" id="perPageSelect" onchange="changePerPage()">
            <option value="10">10ä»¶</option>
            <option value="20" selected>20ä»¶</option>
            <option value="50">50ä»¶</option>
            <option value="100">100ä»¶</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">å‰Šé™¤ã®ç¢ºèª</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">Ã—</button>
      </div>
      <div class="modal-body">
        ã“ã®å®Ÿè¡Œäºˆç®—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>
        <strong id="deleteTargetName"></strong><br><br>
        ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal('deleteModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-danger" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let budgetList = [];
    let filteredList = [];
    let currentPage = 1;
    let perPage = 20;
    let sortColumn = 'updated_at';
    let sortOrder = 'desc';
    let selectedIds = new Set();
    let deleteTargetId = null;

    // XSSå¯¾ç­–
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatAmount(num) {
      return Math.floor(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    function generateSampleData() {
      const projects = [
        { name: 'é•·å´è‡ªå‹•è»Šé“èˆ—è£…è£œä¿®å·¥äº‹', client: 'NEXCOè¥¿æ—¥æœ¬' },
        { name: 'ç¦å²¡ç’°çŠ¶ç·šæ©‹æ¢ç‚¹æ¤œæ¥­å‹™', client: 'ç¦å²¡å¸‚é“è·¯ç®¡ç†èª²' },
        { name: 'åŒ—ä¹å·èˆ—è£…å·¥äº‹', client: 'NEXCOä¹å·' },
        { name: 'ç†Šæœ¬çœŒé“æ•´å‚™å·¥äº‹', client: 'ç†Šæœ¬çœŒåœŸæœ¨éƒ¨' },
        { name: 'ä½è³€ç©ºæ¸¯æ»‘èµ°è·¯è£œä¿®', client: 'ä½è³€çœŒç©ºæ¸¯ç®¡ç†èª²' }
      ];

      const statuses = ['draft', 'pending', 'approved', 'rejected'];
      const data = [];

      for (let i = 1; i <= 45; i++) {
        const proj = projects[i % projects.length];
        const estimateAmount = Math.floor(Math.random() * 50000000) + 5000000;
        const profitRate = Math.floor(Math.random() * 35) + 5;
        const budgetAmount = Math.floor(estimateAmount * (1 - profitRate / 100));

        data.push({
          id: i,
          project_code: `2026-${String(i).padStart(3, '0')}`,
          project_name: proj.name,
          client_name: proj.client,
          estimate_amount: estimateAmount,
          budget_amount: budgetAmount,
          profit_amount: estimateAmount - budgetAmount,
          profit_rate: profitRate,
          status: statuses[Math.floor(Math.random() * statuses.length)],
          created_at: new Date(2026, 0, Math.floor(Math.random() * 11) + 1).toISOString(),
          updated_at: new Date(2026, 0, Math.floor(Math.random() * 11) + 1).toISOString(),
          created_by: { id: 1, name: 'ãŸã' }
        });
      }

      return data;
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      budgetList = generateSampleData();
      filteredList = [...budgetList];
      updateSummary();
      renderTable();
      setupSortable();
    });

    // ã‚µãƒãƒªãƒ¼æ›´æ–°
    function updateSummary() {
      const totalCount = filteredList.length;
      const totalEstimate = filteredList.reduce((sum, item) => sum + item.estimate_amount, 0);
      const totalBudget = filteredList.reduce((sum, item) => sum + item.budget_amount, 0);
      const avgProfitRate = filteredList.length > 0
        ? filteredList.reduce((sum, item) => sum + item.profit_rate, 0) / filteredList.length
        : 0;

      document.getElementById('totalCount').textContent = totalCount + 'ä»¶';
      document.getElementById('totalEstimate').textContent = 'Â¥' + formatAmount(totalEstimate);
      document.getElementById('totalBudget').textContent = 'Â¥' + formatAmount(totalBudget);
      document.getElementById('avgProfitRate').textContent = avgProfitRate.toFixed(1) + '%';
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const emptyState = document.getElementById('emptyState');
      const paginationBar = document.getElementById('paginationBar');

      // ã‚½ãƒ¼ãƒˆ
      const sorted = [...filteredList].sort((a, b) => {
        let valA = a[sortColumn];
        let valB = b[sortColumn];
        if (typeof valA === 'string') {
          valA = valA.toLowerCase();
          valB = valB.toLowerCase();
        }
        if (sortOrder === 'asc') {
          return valA > valB ? 1 : -1;
        } else {
          return valA < valB ? 1 : -1;
        }
      });

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const pageData = sorted.slice(start, end);

      if (pageData.length === 0) {
        tbody.innerHTML = '';
        emptyState.style.display = 'block';
        paginationBar.style.display = 'none';
        return;
      }

      emptyState.style.display = 'none';
      paginationBar.style.display = 'flex';

      tbody.innerHTML = pageData.map(item => {
        const profitClass = item.profit_rate >= 30 ? 'high'
          : item.profit_rate >= 20 ? 'good'
          : item.profit_rate >= 10 ? 'warning'
          : 'danger';

        const statusLabels = {
          draft: 'ä¸‹æ›¸ã',
          pending: 'æ‰¿èªå¾…ã¡',
          approved: 'æ‰¿èªæ¸ˆã¿',
          rejected: 'å´ä¸‹'
        };

        return `
          <tr>
            <td>
              <input type="checkbox"
                data-id="${item.id}"
                ${selectedIds.has(item.id) ? 'checked' : ''}
                onchange="toggleSelect(${item.id})">
            </td>
            <td>
              <span class="project-code" onclick="viewDetail(${item.id})">
                ${escapeHtml(item.project_code)}
              </span>
            </td>
            <td class="project-name">${escapeHtml(item.project_name)}</td>
            <td class="client-name">${escapeHtml(item.client_name)}</td>
            <td class="amount">Â¥${formatAmount(item.estimate_amount)}</td>
            <td class="amount">Â¥${formatAmount(item.budget_amount)}</td>
            <td>
              <span class="profit-rate ${profitClass}">${item.profit_rate}%</span>
            </td>
            <td>
              <span class="status-badge ${item.status}">${statusLabels[item.status]}</span>
            </td>
            <td class="date-cell">${formatDate(item.updated_at)}</td>
            <td class="actions-cell">
              <button class="btn-icon" title="è©³ç´°" onclick="viewDetail(${item.id})">ğŸ‘</button>
              <button class="btn-icon" title="ç·¨é›†" onclick="editBudget(${item.id})">âœï¸</button>
              <button class="btn-icon danger" title="å‰Šé™¤" onclick="deleteBudget(${item.id})">ğŸ—‘</button>
            </td>
          </tr>
        `;
      }).join('');

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°
      renderPagination(sorted.length);
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æç”»
    function renderPagination(total) {
      const totalPages = Math.ceil(total / perPage);
      const start = (currentPage - 1) * perPage + 1;
      const end = Math.min(currentPage * perPage, total);

      document.getElementById('paginationInfo').textContent = `${start}-${end} / ${total}ä»¶`;

      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;

      // ãƒšãƒ¼ã‚¸ç•ªå·
      let pageHtml = '';
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          pageHtml += `
            <button class="pagination-btn ${i === currentPage ? 'active' : ''}"
              onclick="goToPage(${i})">${i}</button>
          `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          pageHtml += '<span style="padding: 0 8px;">...</span>';
        }
      }
      document.getElementById('pageNumbers').innerHTML = pageHtml;
    }

    // ã‚½ãƒ¼ãƒˆè¨­å®š
    function setupSortable() {
      document.querySelectorAll('.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.dataset.sort;
          if (sortColumn === column) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = column;
            sortOrder = 'asc';
          }

          document.querySelectorAll('.sortable').forEach(el => {
            el.classList.remove('asc', 'desc');
          });
          th.classList.add(sortOrder);

          renderTable();
        });
      });
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
    function applyFilters() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const period = document.getElementById('periodFilter').value;
      const profit = document.getElementById('profitFilter').value;

      filteredList = budgetList.filter(item => {
        // æ¤œç´¢
        if (search) {
          const searchFields = [
            item.project_code,
            item.project_name,
            item.client_name
          ].join(' ').toLowerCase();
          if (!searchFields.includes(search)) return false;
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        if (status && item.status !== status) return false;

        // æœŸé–“
        if (period) {
          const now = new Date();
          const itemDate = new Date(item.updated_at);
          if (period === 'this_month') {
            if (itemDate.getMonth() !== now.getMonth() || itemDate.getFullYear() !== now.getFullYear()) return false;
          } else if (period === 'last_month') {
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            if (itemDate.getMonth() !== lastMonth.getMonth() || itemDate.getFullYear() !== lastMonth.getFullYear()) return false;
          }
        }

        // ç²—åˆ©ç‡
        if (profit) {
          const [min, max] = profit.split('-').map(Number);
          if (item.profit_rate < min || item.profit_rate >= max) return false;
        }

        return true;
      });

      currentPage = 1;
      updateSummary();
      renderTable();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('periodFilter').value = '';
      document.getElementById('profitFilter').value = '';
      filteredList = [...budgetList];
      currentPage = 1;
      updateSummary();
      renderTable();
    }

    // ãƒšãƒ¼ã‚¸ç§»å‹•
    function goToPage(page) {
      const totalPages = Math.ceil(filteredList.length / perPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
    }

    // è¡¨ç¤ºä»¶æ•°å¤‰æ›´
    function changePerPage() {
      perPage = parseInt(document.getElementById('perPageSelect').value);
      currentPage = 1;
      renderTable();
    }

    // é¸æŠãƒˆã‚°ãƒ«
    function toggleSelect(id) {
      if (selectedIds.has(id)) {
        selectedIds.delete(id);
      } else {
        selectedIds.add(id);
      }
      updateBulkActions();
    }

    // å…¨é¸æŠãƒˆã‚°ãƒ«
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll').checked;
      const checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]');

      checkboxes.forEach(cb => {
        const id = parseInt(cb.dataset.id);
        if (selectAll) {
          selectedIds.add(id);
          cb.checked = true;
        } else {
          selectedIds.delete(id);
          cb.checked = false;
        }
      });
      updateBulkActions();
    }

    // ä¸€æ‹¬æ“ä½œãƒãƒ¼æ›´æ–°
    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const selectedCount = document.getElementById('selectedCount');

      if (selectedIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedIds.size;
      } else {
        bulkActions.classList.remove('show');
      }
    }

    // è©³ç´°è¡¨ç¤º
    function viewDetail(id) {
      const item = budgetList.find(b => b.id === id);
      if (item) {
        alert(`è©³ç´°è¡¨ç¤º: ${item.project_name}\n\nâ€» è©³ç´°ç”»é¢ã¯åˆ¥é€”å®Ÿè£…äºˆå®š`);
      }
    }

    // ç·¨é›†
    function editBudget(id) {
      const item = budgetList.find(b => b.id === id);
      if (item) {
        alert(`ç·¨é›†: ${item.project_name}\n\nâ€» ç·¨é›†ç”»é¢ã¯åˆ¥é€”å®Ÿè£…äºˆå®š`);
      }
    }

    // å‰Šé™¤
    function deleteBudget(id) {
      const item = budgetList.find(b => b.id === id);
      if (item) {
        deleteTargetId = id;
        document.getElementById('deleteTargetName').textContent = item.project_name;
        document.getElementById('deleteModal').classList.add('show');
      }
    }

    // å‰Šé™¤ç¢ºå®š
    function confirmDelete() {
      if (deleteTargetId) {
        budgetList = budgetList.filter(b => b.id !== deleteTargetId);
        filteredList = filteredList.filter(b => b.id !== deleteTargetId);
        selectedIds.delete(deleteTargetId);
        updateSummary();
        renderTable();
        updateBulkActions();
        closeModal('deleteModal');
        deleteTargetId = null;
      }
    }

    // é¸æŠå‰Šé™¤
    function deleteSelected() {
      if (selectedIds.size === 0) return;
      if (confirm(`${selectedIds.size}ä»¶ã®å®Ÿè¡Œäºˆç®—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        budgetList = budgetList.filter(b => !selectedIds.has(b.id));
        filteredList = filteredList.filter(b => !selectedIds.has(b.id));
        selectedIds.clear();
        updateSummary();
        renderTable();
        updateBulkActions();
      }
    }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportSelected() {
      if (selectedIds.size === 0) return;
      alert(`${selectedIds.size}ä»¶ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ\n\nâ€» ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯åˆ¥é€”å®Ÿè£…äºˆå®š`);
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    // æ¤œç´¢å…¥åŠ›ã§Enterã‚­ãƒ¼
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
  </script>
</body>
</html>
