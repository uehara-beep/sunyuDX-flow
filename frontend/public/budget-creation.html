<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®Ÿè¡Œäºˆç®—æ›¸ä½œæˆ - sunyuTECH-DX</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #E8E4DF;
      color: #2D2D2D;
      margin: 0;
      padding: 0;
    }

    /* ãƒãƒŠãƒ¼ */
    .banner {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 16px 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 500;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      transition: top 0.3s ease;
      max-width: 90%;
    }

    .banner.show {
      top: 20px;
    }

    .banner.error {
      background: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
    }

    .banner.success {
      background: #d1fae5;
      border: 1px solid #22c55e;
      color: #065f46;
    }

    .banner-icon {
      font-size: 18px;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(255,255,255,0.6);
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      font-size: 13px;
      color: rgba(0,0,0,0.7);
      cursor: pointer;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: rgba(0,0,0,0.08);
    }

    .page-title {
      font-size: 18px;
      font-weight: 700;
      color: #1D1D1F;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .save-btn {
      padding: 10px 24px;
      background: linear-gradient(135deg, #FF6B00, #FF8C00);
      border: none;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(255,107,0,0.3);
    }

    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255,107,0,0.4);
    }

    .user-badge {
      padding: 8px 16px;
      background: #0a2540;
      border-radius: 50px;
      font-size: 13px;
      color: #fff;
      font-weight: 600;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
      padding: 24px;
    }

    /* ç§‘ç›®åˆ¥é›†è¨ˆãƒ‘ãƒãƒ« */
    .summary-panel {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      border-left: 4px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .summary-card.labor { border-left-color: #3b82f6; }
    .summary-card.outsource { border-left-color: #8b5cf6; }
    .summary-card.material { border-left-color: #22c55e; }
    .summary-card.equipment { border-left-color: #eab308; }
    .summary-card.expense { border-left-color: #ef4444; }

    .summary-label {
      font-size: 12px;
      color: rgba(0,0,0,0.5);
      margin-bottom: 8px;
    }

    .summary-value {
      font-size: 20px;
      font-weight: 700;
      color: #1D1D1F;
    }

    /* ç²—åˆ©ãƒ‘ãƒãƒ« */
    .profit-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .profit-card {
      background: #0a2540;
      border-radius: 12px;
      padding: 20px;
      color: #fff;
      text-align: center;
    }

    .profit-card.highlight {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    .profit-label {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
    }

    .profit-value {
      font-size: 24px;
      font-weight: 700;
    }

    .profit-badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 14px;
      margin-top: 8px;
    }

    /* ãƒ€ãƒ¼ã‚¯ã‚«ãƒ¼ãƒ‰ */
    .dark-card {
      background: #0a2540;
      border-radius: 16px;
      color: #fff;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .layout-sidebar {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 600px;
    }

    .sidebar {
      background: #0d1f35;
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 20px 0;
    }

    .sidebar-header {
      padding: 0 20px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 16px;
    }

    .sidebar-title {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }

    .sheet-count {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .sheet-list {
      list-style: none;
    }

    .sheet-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
    }

    .sheet-item:hover {
      background: rgba(255,255,255,0.03);
      color: #fff;
    }

    .sheet-item.active {
      background: rgba(255,107,0,0.1);
      border-left-color: #FF6B00;
      color: #FF6B00;
    }

    .sheet-icon {
      font-size: 16px;
    }

    .sheet-badge {
      margin-left: auto;
      font-size: 11px;
      padding: 2px 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 50px;
    }

    .sheet-badge.detail {
      background: rgba(255,107,0,0.2);
      color: #FF6B00;
    }

    .sheet-badge.condition {
      background: rgba(59,130,246,0.2);
      color: #3b82f6;
    }

    .sheet-badge.confirmation {
      background: rgba(34,197,94,0.2);
      color: #22c55e;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .main-area {
      padding: 24px;
    }

    .sheet-header {
      margin-bottom: 20px;
    }

    .sheet-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .sheet-meta {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
    }

    /* æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ8åˆ—ï¼‰ */
    .detail-table {
      width: 100%;
    }

    .table-header {
      display: grid;
      grid-template-columns: 2fr 1fr 80px 50px 110px 120px 100px 120px;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.03);
      font-size: 11px;
      font-weight: 600;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table-row {
      display: grid;
      grid-template-columns: 2fr 1fr 80px 50px 110px 120px 100px 120px;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 13px;
      transition: all 0.2s ease;
    }

    .table-row:hover {
      background: rgba(255,255,255,0.03);
    }

    .row-name {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .row-spec {
      color: rgba(255,255,255,0.6);
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .row-amount {
      text-align: right;
      font-weight: 600;
      color: #FFB74D;
    }

    .row-budget {
      text-align: right;
    }

    .budget-input {
      width: 100%;
      padding: 6px 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      color: #fff;
      font-size: 13px;
      text-align: right;
      transition: all 0.2s;
    }

    .budget-input:focus {
      outline: none;
      border-color: #FF6B00;
      background: rgba(255,255,255,0.08);
      box-shadow: 0 0 0 3px rgba(255,107,0,0.1);
    }

    /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ */
    .category-select, .vendor-select {
      width: 100%;
      padding: 6px 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .category-select:focus, .vendor-select:focus {
      outline: none;
      border-color: #FF6B00;
    }

    .category-select option, .vendor-select option {
      background: #0a2540;
      color: #fff;
    }

    .category-select.unselected, .vendor-select.unselected {
      color: rgba(255,255,255,0.4);
    }

    /* åˆè¨ˆãƒ•ãƒƒã‚¿ãƒ¼ */
    .total-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(0,0,0,0.2);
      margin-top: 20px;
      border-radius: 12px;
    }

    .total-label {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
    }

    .total-value {
      font-size: 20px;
      font-weight: 800;
      color: #FF6B00;
    }

    /* æƒ…å ±ã‚·ãƒ¼ãƒˆè¡¨ç¤º */
    .info-content {
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
    }

    .info-row {
      padding: 8px 0;
      color: rgba(255,255,255,0.8);
      font-size: 14px;
      line-height: 1.6;
    }

    .empty-message {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.4);
      font-size: 14px;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 1200px) {
      .summary-panel {
        grid-template-columns: repeat(3, 1fr);
      }
      .profit-panel {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .summary-panel {
        grid-template-columns: repeat(2, 1fr);
      }
      .layout-sidebar {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼ -->
  <div class="banner error" id="errorBanner">
    <span class="banner-icon">âš ï¸</span>
    <span id="errorMessage">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>
  </div>

  <!-- æˆåŠŸãƒãƒŠãƒ¼ -->
  <div class="banner success" id="successBanner">
    <span class="banner-icon">âœ…</span>
    <span id="successMessage">ä¿å­˜ã—ã¾ã—ãŸ</span>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="page-header">
    <div class="back-btn" onclick="window.location.href='upload-page.html'">
      â† å–¶æ¥­éƒ¨å±‹
    </div>
    <div class="page-title">ğŸ“„ å®Ÿè¡Œäºˆç®—æ›¸ä½œæˆ</div>
    <div class="header-actions">
      <button class="save-btn" onclick="saveBudget()">ğŸ’¾ ä¿å­˜</button>
      <div class="user-badge">ãŸã</div>
    </div>
  </header>

  <!-- ç§‘ç›®åˆ¥é›†è¨ˆãƒ‘ãƒãƒ« -->
  <div class="main-content">
    <div class="summary-panel" id="summaryPanel">
      <div class="summary-card labor">
        <div class="summary-label">åŠ´å‹™è²»</div>
        <div class="summary-value" id="laborTotal">Â¥0</div>
      </div>
      <div class="summary-card outsource">
        <div class="summary-label">å¤–æ³¨è²»</div>
        <div class="summary-value" id="outsourceTotal">Â¥0</div>
      </div>
      <div class="summary-card material">
        <div class="summary-label">ææ–™è²»</div>
        <div class="summary-value" id="materialTotal">Â¥0</div>
      </div>
      <div class="summary-card equipment">
        <div class="summary-label">æ©Ÿæ¢°è²»</div>
        <div class="summary-value" id="equipmentTotal">Â¥0</div>
      </div>
      <div class="summary-card expense">
        <div class="summary-label">çµŒè²»</div>
        <div class="summary-value" id="expenseTotal">Â¥0</div>
      </div>
    </div>

    <!-- ç²—åˆ©ãƒ‘ãƒãƒ« -->
    <div class="profit-panel" id="profitPanel">
      <div class="profit-card">
        <div class="profit-label">è¦‹ç©åˆè¨ˆ</div>
        <div class="profit-value" id="estimateTotal">Â¥0</div>
      </div>
      <div class="profit-card">
        <div class="profit-label">å®Ÿè¡Œäºˆç®—åˆè¨ˆ</div>
        <div class="profit-value" id="budgetTotal">Â¥0</div>
      </div>
      <div class="profit-card">
        <div class="profit-label">ç²—åˆ©é¡</div>
        <div class="profit-value" id="profitAmount">Â¥0</div>
      </div>
      <div class="profit-card highlight">
        <div class="profit-label">ç²—åˆ©ç‡</div>
        <div class="profit-value" id="profitRate">0%</div>
        <div class="profit-badge" id="profitBadge">-</div>
      </div>
    </div>

    <div class="dark-card layout-sidebar">
      <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">ã‚·ãƒ¼ãƒˆä¸€è¦§</div>
          <div class="sheet-count" id="sheetCount">0ã‚·ãƒ¼ãƒˆ</div>
        </div>
        <ul class="sheet-list" id="sheetList">
          <!-- ã‚·ãƒ¼ãƒˆä¸€è¦§ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </ul>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
      <div class="main-area" id="mainArea">
        <div class="empty-message">
          ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
        </div>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let excelData = null;
    let activeSheet = null;
    let budgetData = {};  // { "ã‚·ãƒ¼ãƒˆå-è¡Œç•ªå·": { amount, category, vendor } }
    let allDetailRows = {}; // å…¨ã‚·ãƒ¼ãƒˆã®æ˜ç´°è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

    // å”åŠ›æ¥­è€…ãƒã‚¹ã‚¿
    const vendors = [
      { id: 1, name: 'å”åŠ›æ¥­è€…A', category: 'labor' },
      { id: 2, name: 'å”åŠ›æ¥­è€…B', category: 'outsource' },
      { id: 3, name: 'å”åŠ›æ¥­è€…C', category: 'material' },
      { id: 4, name: 'å”åŠ›æ¥­è€…D', category: 'equipment' },
      { id: 5, name: 'å”åŠ›æ¥­è€…E', category: 'outsource' }
    ];

    // ç§‘ç›®ãƒã‚¹ã‚¿
    const categories = [
      { value: 'labor', label: 'åŠ´å‹™è²»' },
      { value: 'outsource', label: 'å¤–æ³¨è²»' },
      { value: 'material', label: 'ææ–™è²»' },
      { value: 'equipment', label: 'æ©Ÿæ¢°è²»' },
      { value: 'expense', label: 'çµŒè²»' }
    ];

    // XSSå¯¾ç­–: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // ã‚¨ãƒ©ãƒ¼ãƒãƒŠãƒ¼è¡¨ç¤º
    function showError(message) {
      const banner = document.getElementById('errorBanner');
      document.getElementById('errorMessage').textContent = message;
      banner.classList.add('show');
      setTimeout(() => {
        banner.classList.remove('show');
      }, 5000);
    }

    // æˆåŠŸãƒãƒŠãƒ¼è¡¨ç¤º
    function showSuccess(message = 'ä¿å­˜ã—ã¾ã—ãŸ') {
      const banner = document.getElementById('successBanner');
      document.getElementById('successMessage').textContent = message;
      banner.classList.add('show');
      setTimeout(() => {
        banner.classList.remove('show');
      }, 3000);
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener('DOMContentLoaded', () => {
      try {
        loadExcelData();
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError('ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    // sessionStorageã‹ã‚‰Excelãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    function loadExcelData() {
      const stored = sessionStorage.getItem('uploadedExcelData');
      if (stored) {
        try {
          excelData = JSON.parse(stored);
          displaySheets();
          updateSummary();
        } catch (error) {
          console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
          showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          document.getElementById('mainArea').innerHTML = `
            <div class="empty-message">
              ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
              <button onclick="window.location.href='upload-page.html'" style="margin-top: 20px; padding: 10px 24px; background: #FF6B00; border: none; border-radius: 8px; color: white; cursor: pointer;">
                ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã«æˆ»ã‚‹
              </button>
            </div>
          `;
        }
      } else {
        document.getElementById('mainArea').innerHTML = `
          <div class="empty-message">
            ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br>
            <button onclick="window.location.href='upload-page.html'" style="margin-top: 20px; padding: 10px 24px; background: #FF6B00; border: none; border-radius: 8px; color: white; cursor: pointer;">
              ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã«æˆ»ã‚‹
            </button>
          </div>
        `;
      }
    }

    // ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    function displaySheets() {
      if (!excelData || !excelData.sheetNames || excelData.sheetNames.length === 0) {
        return;
      }

      document.getElementById('sheetCount').textContent = excelData.sheetNames.length + 'ã‚·ãƒ¼ãƒˆ';

      const sheetList = document.getElementById('sheetList');
      sheetList.innerHTML = '';

      excelData.sheetNames.forEach((sheetName, index) => {
        const sheetType = detectSheetType(sheetName);
        const icon = getSheetIcon(sheetType);
        const badge = getSheetBadge(sheetType);

        const li = document.createElement('li');
        li.className = 'sheet-item';
        if (index === 0) {
          li.classList.add('active');
          activeSheet = sheetName;
        }

        li.innerHTML = `
          <span class="sheet-icon">${icon}</span>
          <span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(sheetName)}</span>
          ${badge}
        `;

        li.addEventListener('click', () => {
          document.querySelectorAll('.sheet-item').forEach(item => item.classList.remove('active'));
          li.classList.add('active');
          activeSheet = sheetName;
          displaySheetContent(sheetName);
        });

        sheetList.appendChild(li);

        // å†…è¨³ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰ã«è§£æ
        if (sheetType === 'detail') {
          parseDetailSheet(sheetName);
        }
      });

      // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º
      if (excelData.sheetNames.length > 0) {
        displaySheetContent(excelData.sheetNames[0]);
      }
    }

    // ã‚·ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—åˆ¤å®š
    function detectSheetType(sheetName) {
      const name = sheetName.toLowerCase();
      if (name.includes('æ¡ä»¶')) return 'condition';
      if (name.includes('ç¢ºèª')) return 'confirmation';
      if (name.includes('è¡¨ç´™') || name.includes('ç·æ‹¬')) return 'cover';
      return 'detail';
    }

    // ã‚·ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³
    function getSheetIcon(type) {
      const icons = {
        detail: 'ğŸ“‹',
        condition: 'ğŸ“',
        confirmation: 'âœ…',
        cover: 'ğŸ“‘'
      };
      return icons[type] || 'ğŸ“„';
    }

    // ã‚·ãƒ¼ãƒˆãƒãƒƒã‚¸
    function getSheetBadge(type) {
      if (type === 'detail') return '<span class="sheet-badge detail">å†…è¨³</span>';
      if (type === 'condition') return '<span class="sheet-badge condition">æ¡ä»¶</span>';
      if (type === 'confirmation') return '<span class="sheet-badge confirmation">ç¢ºèª</span>';
      return '';
    }

    // å†…è¨³ã‚·ãƒ¼ãƒˆè§£æï¼ˆäº‹å‰å‡¦ç†ï¼‰
    function parseDetailSheet(sheetName) {
      const sheetData = excelData.sheets[sheetName];
      if (!sheetData || sheetData.length === 0) return;

      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¢ã™
      let headerRowIndex = -1;
      for (let i = 0; i < Math.min(30, sheetData.length); i++) {
        const row = sheetData[i];
        const rowText = row.join('').toLowerCase();
        if (rowText.includes('åç§°') && rowText.includes('æ•°é‡') && rowText.includes('é‡‘é¡')) {
          headerRowIndex = i;
          break;
        }
      }

      if (headerRowIndex === -1) return;

      const headers = sheetData[headerRowIndex];
      const nameIdx = headers.findIndex(h => h && h.toString().includes('åç§°'));
      const amountIdx = headers.findIndex(h => h && h.toString().includes('é‡‘é¡'));

      const rows = [];
      for (let i = headerRowIndex + 1; i < sheetData.length; i++) {
        const row = sheetData[i];
        const name = row[nameIdx];
        const amount = parseFloat(row[amountIdx]) || 0;

        if (name && amount > 0) {
          const nameStr = name.toString().toLowerCase();
          if (!nameStr.includes('å°è¨ˆ') && !nameStr.includes('åˆè¨ˆ')) {
            rows.push({
              name: row[nameIdx] || '',
              amount: amount,
              rowIndex: i
            });
          }
        }
      }

      allDetailRows[sheetName] = rows;
    }

    // ã‚·ãƒ¼ãƒˆå†…å®¹è¡¨ç¤º
    function displaySheetContent(sheetName) {
      try {
        const sheetData = excelData.sheets[sheetName];
        if (!sheetData || sheetData.length === 0) {
          document.getElementById('mainArea').innerHTML = '<div class="empty-message">ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        const sheetType = detectSheetType(sheetName);

        if (sheetType === 'detail') {
          displayDetailSheet(sheetName, sheetData);
        } else {
          displayInfoSheet(sheetName, sheetData, sheetType);
        }
      } catch (error) {
        console.error('ã‚·ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        showError('ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // å†…è¨³æ˜ç´°ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    function displayDetailSheet(sheetName, data) {
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¢ã™
      let headerRowIndex = -1;
      for (let i = 0; i < Math.min(30, data.length); i++) {
        const row = data[i];
        const rowText = row.join('').toLowerCase();
        if (rowText.includes('åç§°') && rowText.includes('æ•°é‡') && rowText.includes('é‡‘é¡')) {
          headerRowIndex = i;
          break;
        }
      }

      if (headerRowIndex === -1) {
        document.getElementById('mainArea').innerHTML = '<div class="empty-message">å†…è¨³æ˜ç´°ã®å½¢å¼ã‚’èªè­˜ã§ãã¾ã›ã‚“</div>';
        return;
      }

      // ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—
      const headers = data[headerRowIndex];
      const nameIdx = headers.findIndex(h => h && h.toString().includes('åç§°'));
      const specIdx = headers.findIndex(h => h && h.toString().includes('è¦æ ¼'));
      const quantityIdx = headers.findIndex(h => h && h.toString().includes('æ•°é‡'));
      const unitIdx = headers.findIndex(h => h && h.toString().includes('å˜ä½'));
      const amountIdx = headers.findIndex(h => h && h.toString().includes('é‡‘é¡'));

      // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’æŠ½å‡º
      const rows = [];
      let sheetTotal = 0;
      for (let i = headerRowIndex + 1; i < data.length; i++) {
        const row = data[i];
        const name = row[nameIdx];
        const amount = parseFloat(row[amountIdx]) || 0;

        if (name && amount > 0) {
          const nameStr = name.toString().toLowerCase();
          if (!nameStr.includes('å°è¨ˆ') && !nameStr.includes('åˆè¨ˆ')) {
            rows.push({
              name: row[nameIdx] || '',
              spec: row[specIdx] || '',
              quantity: row[quantityIdx] || '',
              unit: row[unitIdx] || '',
              amount: amount,
              rowIndex: i
            });
            sheetTotal += amount;
          }
        }
      }

      // ç§‘ç›®ã‚»ãƒ¬ã‚¯ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
      const categoryOptions = categories.map(c =>
        `<option value="${c.value}">${c.label}</option>`
      ).join('');

      // æ¥­è€…ã‚»ãƒ¬ã‚¯ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
      const vendorOptions = vendors.map(v =>
        `<option value="${v.id}">${escapeHtml(v.name)}</option>`
      ).join('');

      // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
      let html = `
        <div class="sheet-header">
          <div class="sheet-name">${escapeHtml(sheetName)}</div>
          <div class="sheet-meta">å†…è¨³æ˜ç´°æ›¸ | ${rows.length}é …ç›®</div>
        </div>
        <div class="detail-table">
          <div class="table-header">
            <div>åç§°</div>
            <div>è¦æ ¼</div>
            <div>æ•°é‡</div>
            <div>å˜ä½</div>
            <div>é‡‘é¡</div>
            <div>å®Ÿè¡Œäºˆç®—</div>
            <div>ç§‘ç›®</div>
            <div>å”åŠ›æ¥­è€…</div>
          </div>
      `;

      rows.forEach((row, idx) => {
        const budgetKey = `${sheetName}-${idx}`;
        const budgetInfo = budgetData[budgetKey] || { amount: '', category: '', vendor: '' };

        html += `
          <div class="table-row">
            <div class="row-name" title="${escapeHtml(row.name)}">${escapeHtml(row.name)}</div>
            <div class="row-spec" title="${escapeHtml(row.spec)}">${escapeHtml(row.spec)}</div>
            <div>${escapeHtml(row.quantity)}</div>
            <div>${escapeHtml(row.unit)}</div>
            <div class="row-amount">Â¥${formatAmount(row.amount)}</div>
            <div class="row-budget">
              <input
                type="text"
                class="budget-input"
                data-key="${escapeHtml(budgetKey)}"
                value="${escapeHtml(budgetInfo.amount)}"
                placeholder="å…¥åŠ›"
              >
            </div>
            <div>
              <select class="category-select ${budgetInfo.category ? '' : 'unselected'}" data-key="${escapeHtml(budgetKey)}">
                <option value="">é¸æŠ</option>
                ${categoryOptions}
              </select>
            </div>
            <div>
              <select class="vendor-select ${budgetInfo.vendor ? '' : 'unselected'}" data-key="${escapeHtml(budgetKey)}">
                <option value="">æœªé¸æŠ</option>
                ${vendorOptions}
              </select>
            </div>
          </div>
        `;
      });

      html += `
        </div>
        <div class="total-footer">
          <div class="total-label">ã“ã®ã‚·ãƒ¼ãƒˆåˆè¨ˆ</div>
          <div class="total-value">Â¥${formatAmount(sheetTotal)}</div>
        </div>
      `;

      document.getElementById('mainArea').innerHTML = html;

      // ä¿å­˜æ¸ˆã¿ã®å€¤ã‚’è¨­å®š
      document.querySelectorAll('.category-select').forEach(select => {
        const key = select.dataset.key;
        const info = budgetData[key];
        if (info && info.category) {
          select.value = info.category;
          select.classList.remove('unselected');
        }
      });

      document.querySelectorAll('.vendor-select').forEach(select => {
        const key = select.dataset.key;
        const info = budgetData[key];
        if (info && info.vendor) {
          select.value = info.vendor;
          select.classList.remove('unselected');
        }
      });

      // å®Ÿè¡Œäºˆç®—å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.budget-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const key = e.target.dataset.key;
          let value = e.target.value.replace(/[^\d]/g, '');
          if (value.length > 15) {
            value = value.slice(0, 15);
          }
          e.target.value = value;

          if (!budgetData[key]) {
            budgetData[key] = { amount: '', category: '', vendor: '' };
          }
          budgetData[key].amount = value;
          updateSummary();
        });
      });

      // ç§‘ç›®é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.category-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const key = e.target.dataset.key;
          const value = e.target.value;

          if (!budgetData[key]) {
            budgetData[key] = { amount: '', category: '', vendor: '' };
          }
          budgetData[key].category = value;

          if (value) {
            e.target.classList.remove('unselected');
          } else {
            e.target.classList.add('unselected');
          }
          updateSummary();
        });
      });

      // å”åŠ›æ¥­è€…é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.vendor-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const key = e.target.dataset.key;
          const value = e.target.value;

          if (!budgetData[key]) {
            budgetData[key] = { amount: '', category: '', vendor: '' };
          }
          budgetData[key].vendor = value;

          if (value) {
            e.target.classList.remove('unselected');
          } else {
            e.target.classList.add('unselected');
          }
        });
      });
    }

    // æƒ…å ±ã‚·ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆæ¡ä»¶æ›¸ã€ç¢ºèªæ›¸ã€è¡¨ç´™ï¼‰
    function displayInfoSheet(sheetName, data, type) {
      let typeName = 'æƒ…å ±';
      if (type === 'condition') typeName = 'æ¡ä»¶æ›¸';
      if (type === 'confirmation') typeName = 'ç¢ºèªæ›¸';
      if (type === 'cover') typeName = 'è¡¨ç´™';

      let html = `
        <div class="sheet-header">
          <div class="sheet-name">${escapeHtml(sheetName)}</div>
          <div class="sheet-meta">${escapeHtml(typeName)}</div>
        </div>
        <div class="info-content">
      `;

      data.forEach((row, idx) => {
        if (idx > 100) return;
        const rowData = row.filter(cell => cell !== '').join(' | ');
        if (rowData) {
          html += `<div class="info-row">${escapeHtml(rowData)}</div>`;
        }
      });

      html += '</div>';
      document.getElementById('mainArea').innerHTML = html;
    }

    // é›†è¨ˆæ›´æ–°
    function updateSummary() {
      const categoryTotals = {
        labor: 0,
        outsource: 0,
        material: 0,
        equipment: 0,
        expense: 0
      };

      let estimateTotal = 0;
      let budgetTotal = 0;

      // å…¨ã‚·ãƒ¼ãƒˆã®æ˜ç´°ã‚’é›†è¨ˆ
      Object.keys(allDetailRows).forEach(sheetName => {
        const rows = allDetailRows[sheetName];
        rows.forEach((row, idx) => {
          const key = `${sheetName}-${idx}`;
          const info = budgetData[key];

          estimateTotal += row.amount;

          if (info && info.amount) {
            const amount = parseFloat(info.amount) || 0;
            budgetTotal += amount;

            if (info.category && categoryTotals.hasOwnProperty(info.category)) {
              categoryTotals[info.category] += amount;
            }
          }
        });
      });

      // ç§‘ç›®åˆ¥é›†è¨ˆã‚’æ›´æ–°
      document.getElementById('laborTotal').textContent = 'Â¥' + formatAmount(categoryTotals.labor);
      document.getElementById('outsourceTotal').textContent = 'Â¥' + formatAmount(categoryTotals.outsource);
      document.getElementById('materialTotal').textContent = 'Â¥' + formatAmount(categoryTotals.material);
      document.getElementById('equipmentTotal').textContent = 'Â¥' + formatAmount(categoryTotals.equipment);
      document.getElementById('expenseTotal').textContent = 'Â¥' + formatAmount(categoryTotals.expense);

      // ç²—åˆ©è¨ˆç®—
      const profitAmount = estimateTotal - budgetTotal;
      const profitRate = estimateTotal > 0 ? (profitAmount / estimateTotal) * 100 : 0;

      document.getElementById('estimateTotal').textContent = 'Â¥' + formatAmount(estimateTotal);
      document.getElementById('budgetTotal').textContent = 'Â¥' + formatAmount(budgetTotal);
      document.getElementById('profitAmount').textContent = 'Â¥' + formatAmount(profitAmount);
      document.getElementById('profitRate').textContent = profitRate.toFixed(1) + '%';

      // ç²—åˆ©ãƒãƒƒã‚¸æ›´æ–°
      const badge = document.getElementById('profitBadge');
      if (profitRate >= 25) {
        badge.textContent = 'å„ªè‰¯';
        badge.style.background = 'rgba(255,255,255,0.3)';
      } else if (profitRate >= 15) {
        badge.textContent = 'è‰¯å¥½';
        badge.style.background = 'rgba(255,255,255,0.2)';
      } else if (profitRate > 0) {
        badge.textContent = 'è¦æ³¨æ„';
        badge.style.background = 'rgba(255,193,7,0.3)';
      } else {
        badge.textContent = '-';
        badge.style.background = 'rgba(255,255,255,0.2)';
      }
    }

    // ä¿å­˜å‡¦ç†
    function saveBudget() {
      try {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const budgetKeys = Object.keys(budgetData);
        if (budgetKeys.length === 0) {
          showError('å®Ÿè¡Œäºˆç®—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        let hasValidData = false;
        let hasInvalidData = false;

        budgetKeys.forEach(key => {
          const info = budgetData[key];
          if (info.amount) {
            const amount = parseFloat(info.amount);
            if (amount > 0) {
              hasValidData = true;
            } else if (amount < 0) {
              hasInvalidData = true;
            }
          }
        });

        if (!hasValidData) {
          showError('æœ‰åŠ¹ãªå®Ÿè¡Œäºˆç®—ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        if (hasInvalidData) {
          showError('ç„¡åŠ¹ãªå®Ÿè¡Œäºˆç®—é¡ãŒã‚ã‚Šã¾ã™');
          return;
        }

        // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
        const saveData = {
          timestamp: new Date().toISOString(),
          budgetDetails: budgetData,
          summary: {
            estimateTotal: parseFloat(document.getElementById('estimateTotal').textContent.replace(/[Â¥,]/g, '')) || 0,
            budgetTotal: parseFloat(document.getElementById('budgetTotal').textContent.replace(/[Â¥,]/g, '')) || 0,
            profitRate: parseFloat(document.getElementById('profitRate').textContent) || 0
          }
        };

        // sessionStorageã«ä¸€æ™‚ä¿å­˜
        sessionStorage.setItem('budgetData', JSON.stringify(saveData));

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ï¼ˆAPIé€£æºç”¨ï¼‰
        console.log('ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', saveData);

        showSuccess('å®Ÿè¡Œäºˆç®—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');

      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showError('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatAmount(num) {
      return Math.floor(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
  </script>
</body>
</html>
