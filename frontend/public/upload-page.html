<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¦‹ç©æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ - sunyuTECH-DX</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #E8E4DF;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 32px;
      background: transparent;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: white;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      background: #f5f5f5;
      transform: translateX(-2px);
    }
    
    .header-title {
      font-size: 28px;
      font-weight: 700;
      color: #0a2540;
    }
    
    .user-btn {
      width: 56px;
      height: 56px;
      background: #0a2540;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .user-btn:hover {
      background: #0d3a5c;
      transform: scale(1.05);
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .container {
      max-width: 1300px;
      margin: 0 auto;
      padding: 40px 32px;
    }
    
    .upload-card {
      background: #0a2540;
      border-radius: 24px;
      padding: 80px 60px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    }
    
    .card-title {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin-bottom: 20px;
    }
    
    /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
    .dropzone {
      border: 3px dashed rgba(255,107,0,0.5);
      border-radius: 16px;
      padding: 100px 40px;
      margin: 40px 0;
      background: rgba(255,107,0,0.03);
      transition: all 0.3s;
      cursor: pointer;
    }
    
    .dropzone:hover,
    .dropzone.dragover {
      border-color: #FF6B00;
      background: rgba(255,107,0,0.08);
      transform: translateY(-2px);
    }
    
    .dropzone-icon {
      font-size: 72px;
      margin-bottom: 24px;
    }
    
    .dropzone-text {
      font-size: 20px;
      font-weight: 600;
      color: white;
      margin-bottom: 12px;
    }
    
    .dropzone-subtext {
      font-size: 16px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 8px;
    }
    
    .dropzone-formats {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
    }
    
    /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¸ˆã¿è¡¨ç¤º */
    .file-selected {
      display: none;
      background: rgba(34,197,94,0.1);
      border: 2px solid rgba(34,197,94,0.3);
      border-radius: 16px;
      padding: 32px;
      margin: 40px 0;
    }
    
    .file-selected.show {
      display: block;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .file-icon {
      font-size: 48px;
    }
    
    .file-details {
      text-align: left;
    }
    
    .file-name {
      font-size: 18px;
      font-weight: 600;
      color: white;
      margin-bottom: 4px;
    }
    
    .file-meta {
      font-size: 14px;
      color: rgba(255,255,255,0.6);
    }
    
    .sheet-preview {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .sheet-badge {
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 50px;
      font-size: 13px;
      color: rgba(255,255,255,0.8);
    }
    
    /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
    .upload-btn {
      width: 100%;
      max-width: 600px;
      padding: 24px;
      background: linear-gradient(135deg, #8B7355 0%, #6B5444 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin: 0 auto;
    }
    
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(139,115,85,0.4);
    }
    
    .upload-btn:active {
      transform: translateY(0);
    }
    
    /* æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³ */
    .next-btn {
      width: 100%;
      max-width: 600px;
      padding: 24px;
      background: linear-gradient(135deg, #FF6B00 0%, #FF8533 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin: 0 auto;
    }
    
    .next-btn.show {
      display: flex;
    }
    
    .next-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(255,107,0,0.4);
    }
    
    .next-btn:active {
      transform: translateY(0);
    }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      display: none;
      color: rgba(255,255,255,0.7);
      font-size: 16px;
      margin-top: 20px;
    }
    
    .loading.show {
      display: block;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="header">
    <button class="back-btn" onclick="window.history.back()">
      â† å–¶æ¥­éƒ¨å±‹
    </button>
    <h1 class="header-title">è¦‹ç©æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
    <button class="user-btn">ãŸã</button>
  </header>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="container">
    <div class="upload-card">
      <h2 class="card-title">è¦‹ç©Excelã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      
      <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
      <div id="dropzone" class="dropzone">
        <div class="dropzone-icon">â¬†ï¸</div>
        <div class="dropzone-text">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="dropzone-subtext">ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
        <div class="dropzone-formats">.xlsx, .xls å½¢å¼å¯¾å¿œ</div>
      </div>
      
      <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ¸ˆã¿è¡¨ç¤º -->
      <div id="fileSelected" class="file-selected">
        <div class="file-info">
          <div class="file-icon">ğŸ“Š</div>
          <div class="file-details">
            <div class="file-name" id="fileName">ãƒ•ã‚¡ã‚¤ãƒ«å</div>
            <div class="file-meta">
              <span id="fileSize">0 KB</span> â€¢ 
              <span id="sheetCount">0 ã‚·ãƒ¼ãƒˆ</span>
            </div>
          </div>
        </div>
        <div id="sheetPreview" class="sheet-preview"></div>
      </div>
      
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="loading" class="loading">
        èª­ã¿è¾¼ã¿ä¸­...
      </div>
      
      <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
      <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
      <button id="uploadBtn" class="upload-btn">
        <span style="font-size: 24px;">ğŸ“¤</span>
        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      </button>
      
      <!-- æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³ -->
      <button id="nextBtn" class="next-btn">
        å®Ÿè¡Œäºˆç®—æ›¸ä½œæˆã¸é€²ã‚€ â†’
      </button>
    </div>
  </div>

  <script>
    let excelData = null;
    let uploadedFile = null;

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const nextBtn = document.getElementById('nextBtn');
    const dropzone = document.getElementById('dropzone');
    const fileSelected = document.getElementById('fileSelected');
    const loading = document.getElementById('loading');

    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    uploadBtn.addEventListener('click', () => {
      fileInput.click();
    });

    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚¯ãƒªãƒƒã‚¯
    dropzone.addEventListener('click', () => {
      fileInput.click();
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
        handleFile(file);
      }
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    function handleFile(file) {
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚\n10MBä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        dropzone.classList.remove('hidden');
        return;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
      const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
        'application/vnd.ms-excel' // .xls
      ];
      if (file.type && !allowedTypes.includes(file.type)) {
        alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsx, .xlsï¼‰ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚');
        dropzone.classList.remove('hidden');
        return;
      }

      // æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯ï¼ˆMIMEã‚¿ã‚¤ãƒ—ãŒå–ã‚Œãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      const fileName = file.name.toLowerCase();
      if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
        alert('Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsx, .xlsï¼‰ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚');
        dropzone.classList.remove('hidden');
        return;
      }

      uploadedFile = file;
      loading.classList.add('show');
      dropzone.classList.add('hidden');

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          
          excelData = {
            workbook: workbook,
            fileName: file.name,
            fileSize: (file.size / 1024).toFixed(1),
            sheetNames: workbook.SheetNames
          };

          displayFileInfo();
          loading.classList.remove('show');
          fileSelected.classList.add('show');
          nextBtn.classList.add('show');
        } catch (error) {
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          loading.classList.remove('show');
          dropzone.classList.remove('hidden');
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
    function displayFileInfo() {
      document.getElementById('fileName').textContent = excelData.fileName;
      document.getElementById('fileSize').textContent = excelData.fileSize + ' KB';
      document.getElementById('sheetCount').textContent = excelData.sheetNames.length + ' ã‚·ãƒ¼ãƒˆ';

      const previewContainer = document.getElementById('sheetPreview');
      previewContainer.innerHTML = '';
      
      excelData.sheetNames.forEach(name => {
        const badge = document.createElement('div');
        badge.className = 'sheet-badge';
        badge.textContent = name;
        previewContainer.appendChild(badge);
      });
    }

    // æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³
    nextBtn.addEventListener('click', () => {
      // Excelãƒ‡ãƒ¼ã‚¿ã‚’sessionStorageã«ä¿å­˜ï¼ˆã‚¿ãƒ–ã‚’é–‰ã˜ãŸã‚‰è‡ªå‹•å‰Šé™¤ï¼‰
      try {
        const dataToStore = {
          fileName: excelData.fileName,
          fileSize: excelData.fileSize,
          sheetNames: excelData.sheetNames,
          sheets: {}
        };

        // å„ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        excelData.sheetNames.forEach(sheetName => {
          const worksheet = excelData.workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
          dataToStore.sheets[sheetName] = jsonData;
        });

        sessionStorage.setItem('uploadedExcelData', JSON.stringify(dataToStore));
        
        // å®Ÿè¡Œäºˆç®—æ›¸ä½œæˆãƒšãƒ¼ã‚¸ã¸é·ç§»
        window.location.href = 'budget-creation.html';
      } catch (error) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    });
  </script>
</body>
</html>
