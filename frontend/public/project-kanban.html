<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡ˆä»¶ç®¡ç†ï¼ˆã‚«ãƒ³ãƒãƒ³ï¼‰ - sunyuTECH-DX</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #E8E4DF;
      color: #2D2D2D;
      min-height: 100vh;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: rgba(255,255,255,0.8);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      font-size: 13px;
      color: rgba(0,0,0,0.7);
      text-decoration: none;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      color: #1D1D1F;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-primary {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #FF6B00, #FF8C00);
      border: none;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(255,107,0,0.3);
    }

    .btn-secondary {
      padding: 10px 20px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 50px;
      font-size: 14px;
      color: rgba(0,0,0,0.7);
      cursor: pointer;
    }

    .user-badge {
      padding: 8px 16px;
      background: #0a2540;
      border-radius: 50px;
      font-size: 13px;
      color: #fff;
      font-weight: 600;
    }

    /* ã‚µãƒãƒªãƒ¼ãƒãƒ¼ */
    .summary-bar {
      display: flex;
      gap: 24px;
      padding: 16px 24px;
      background: #fff;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }

    .summary-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .summary-label {
      font-size: 13px;
      color: rgba(0,0,0,0.5);
    }

    .summary-value {
      font-size: 16px;
      font-weight: 700;
      color: #1D1D1F;
    }

    .summary-value.highlight {
      color: #FF6B00;
    }

    /* ã‚«ãƒ³ãƒãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .kanban-container {
      display: flex;
      gap: 16px;
      padding: 24px;
      overflow-x: auto;
      min-height: calc(100vh - 180px);
    }

    /* ã‚«ãƒ³ãƒãƒ³åˆ— */
    .kanban-column {
      flex: 0 0 320px;
      background: rgba(255,255,255,0.5);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 220px);
    }

    .column-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .column-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #1D1D1F;
    }

    .column-count {
      padding: 2px 10px;
      background: rgba(0,0,0,0.08);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .column-amount {
      font-size: 12px;
      color: rgba(0,0,0,0.4);
    }

    .column-body {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¸è‰² */
    .column-header.lead { border-left: 4px solid #6b7280; }
    .column-header.negotiation { border-left: 4px solid #3b82f6; }
    .column-header.quoted { border-left: 4px solid #f59e0b; }
    .column-header.won { border-left: 4px solid #10b981; }
    .column-header.lost { border-left: 4px solid #ef4444; }

    /* ã‚«ãƒ³ãƒãƒ³ã‚«ãƒ¼ãƒ‰ */
    .kanban-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: grab;
      transition: all 0.2s;
    }

    .kanban-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .kanban-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .kanban-card.drag-over {
      border: 2px dashed #FF6B00;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .card-code {
      font-family: 'SF Mono', monospace;
      font-size: 11px;
      color: #FF6B00;
    }

    .card-probability {
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(59,130,246,0.1);
      color: #3b82f6;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .card-client {
      font-size: 12px;
      color: rgba(0,0,0,0.5);
      margin-bottom: 12px;
    }

    .card-amount {
      font-size: 18px;
      font-weight: 700;
      color: #1D1D1F;
      margin-bottom: 4px;
    }

    .card-forecast {
      font-size: 11px;
      color: rgba(0,0,0,0.4);
      margin-bottom: 12px;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid rgba(0,0,0,0.05);
    }

    .card-assignee {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: rgba(0,0,0,0.6);
    }

    .assignee-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #0a2540;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    .card-date {
      font-size: 11px;
      color: rgba(0,0,0,0.4);
    }

    .card-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .card-tag {
      padding: 2px 8px;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
      font-size: 10px;
      color: rgba(0,0,0,0.6);
    }

    /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
    .drop-zone {
      min-height: 100px;
      border: 2px dashed transparent;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .drop-zone.active {
      border-color: #FF6B00;
      background: rgba(255,107,0,0.05);
    }

    /* ç©ºçŠ¶æ…‹ */
    .empty-column {
      text-align: center;
      padding: 40px 20px;
      color: rgba(0,0,0,0.3);
      font-size: 13px;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 560px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(0,0,0,0.05);
      font-size: 18px;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: rgba(0,0,0,0.6);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background: #f5f5f5;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      font-size: 14px;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #FF6B00;
      background: #fff;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-cancel {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-save {
      flex: 1;
      padding: 12px 20px;
      background: #FF6B00;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
    }

    /* ãƒãƒŠãƒ¼ */
    .banner {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 16px 24px;
      border-radius: 12px;
      background: #d1fae5;
      border: 1px solid #22c55e;
      color: #065f46;
      font-size: 14px;
      font-weight: 500;
      transition: top 0.3s ease;
    }

    .banner.show {
      top: 20px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .summary-bar {
        flex-wrap: wrap;
      }

      .kanban-column {
        flex: 0 0 280px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒãƒŠãƒ¼ -->
  <div class="banner" id="banner">âœ… æ›´æ–°ã—ã¾ã—ãŸ</div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="page-header">
    <div class="header-left">
      <a href="budget-list.html" class="back-btn">â† æˆ»ã‚‹</a>
      <h1 class="page-title">ğŸ“‹ æ¡ˆä»¶ç®¡ç†</h1>
    </div>
    <div class="header-actions">
      <button class="btn-secondary" onclick="switchToList()">ä¸€è¦§è¡¨ç¤º</button>
      <button class="btn-primary" onclick="openNewModal()">+ æ–°è¦æ¡ˆä»¶</button>
      <div class="user-badge">ãŸã</div>
    </div>
  </header>

  <!-- ã‚µãƒãƒªãƒ¼ãƒãƒ¼ -->
  <div class="summary-bar">
    <div class="summary-item">
      <span class="summary-label">ç·æ¡ˆä»¶æ•°:</span>
      <span class="summary-value" id="totalCount">12ä»¶</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">ç·è¦‹ç©é‡‘é¡:</span>
      <span class="summary-value highlight" id="totalAmount">Â¥2.5å„„</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">äºˆæ¸¬å£²ä¸Š:</span>
      <span class="summary-value" id="forecastAmount">Â¥1.2å„„</span>
    </div>
  </div>

  <!-- ã‚«ãƒ³ãƒãƒ³ãƒœãƒ¼ãƒ‰ -->
  <div class="kanban-container">
    <!-- ãƒªãƒ¼ãƒ‰ -->
    <div class="kanban-column" data-stage="lead">
      <div class="column-header lead">
        <div class="column-title">
          ğŸ¯ ãƒªãƒ¼ãƒ‰
          <span class="column-count" id="leadCount">2</span>
        </div>
        <span class="column-amount" id="leadAmount">Â¥3,500ä¸‡</span>
      </div>
      <div class="column-body drop-zone" id="leadColumn">
        <!-- ã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
      </div>
    </div>

    <!-- å•†è«‡ä¸­ -->
    <div class="kanban-column" data-stage="negotiation">
      <div class="column-header negotiation">
        <div class="column-title">
          ğŸ’¬ å•†è«‡ä¸­
          <span class="column-count" id="negotiationCount">3</span>
        </div>
        <span class="column-amount" id="negotiationAmount">Â¥5,200ä¸‡</span>
      </div>
      <div class="column-body drop-zone" id="negotiationColumn">
      </div>
    </div>

    <!-- è¦‹ç©æå‡º -->
    <div class="kanban-column" data-stage="quoted">
      <div class="column-header quoted">
        <div class="column-title">
          ğŸ“„ è¦‹ç©æå‡º
          <span class="column-count" id="quotedCount">4</span>
        </div>
        <span class="column-amount" id="quotedAmount">Â¥8,500ä¸‡</span>
      </div>
      <div class="column-body drop-zone" id="quotedColumn">
      </div>
    </div>

    <!-- å—æ³¨ç¢ºå®š -->
    <div class="kanban-column" data-stage="won">
      <div class="column-header won">
        <div class="column-title">
          ğŸ‰ å—æ³¨ç¢ºå®š
          <span class="column-count" id="wonCount">2</span>
        </div>
        <span class="column-amount" id="wonAmount">Â¥6,500ä¸‡</span>
      </div>
      <div class="column-body drop-zone" id="wonColumn">
      </div>
    </div>

    <!-- å¤±æ³¨ -->
    <div class="kanban-column" data-stage="lost">
      <div class="column-header lost">
        <div class="column-title">
          âŒ å¤±æ³¨
          <span class="column-count" id="lostCount">1</span>
        </div>
        <span class="column-amount" id="lostAmount">Â¥1,500ä¸‡</span>
      </div>
      <div class="column-body drop-zone" id="lostColumn">
      </div>
    </div>
  </div>

  <!-- æ–°è¦æ¡ˆä»¶ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="newModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">æ–°è¦æ¡ˆä»¶ç™»éŒ²</h3>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <form id="projectForm" onsubmit="saveProject(event)">
        <div class="form-group">
          <label class="form-label">æ¡ˆä»¶å *</label>
          <input type="text" class="form-input" id="projectName" required placeholder="æ¡ˆä»¶åã‚’å…¥åŠ›">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">é¡§å®¢å *</label>
            <input type="text" class="form-input" id="clientName" required placeholder="é¡§å®¢å">
          </div>
          <div class="form-group">
            <label class="form-label">æ‹…å½“è€…</label>
            <select class="form-select" id="assignee">
              <option value="1">ãŸã</option>
              <option value="2">å±±ç”°</option>
              <option value="3">ä½è—¤</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">è¦‹ç©é‡‘é¡ *</label>
            <input type="number" class="form-input" id="amount" required placeholder="0">
          </div>
          <div class="form-group">
            <label class="form-label">å—æ³¨äºˆå®šæ—¥</label>
            <input type="date" class="form-input" id="closeDate">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¸</label>
          <select class="form-select" id="stage">
            <option value="lead">ãƒªãƒ¼ãƒ‰</option>
            <option value="negotiation">å•†è«‡ä¸­</option>
            <option value="quoted">è¦‹ç©æå‡º</option>
            <option value="won">å—æ³¨ç¢ºå®š</option>
            <option value="lost">å¤±æ³¨</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å‚™è€ƒ</label>
          <textarea class="form-textarea" id="description" placeholder="æ¡ˆä»¶ã®è©³ç´°æƒ…å ±"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button type="submit" class="btn-save">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let projects = [];
    let draggedCard = null;

    // ç¢ºåº¦ãƒãƒƒãƒ”ãƒ³ã‚°
    const stageProbability = {
      lead: 10,
      negotiation: 30,
      quoted: 60,
      won: 100,
      lost: 0
    };

    // XSSå¯¾ç­–
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatAmount(num) {
      if (num >= 100000000) {
        return 'Â¥' + (num / 100000000).toFixed(1) + 'å„„';
      } else if (num >= 10000) {
        return 'Â¥' + Math.floor(num / 10000).toLocaleString() + 'ä¸‡';
      }
      return 'Â¥' + num.toLocaleString();
    }

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    function generateSampleData() {
      return [
        {
          id: 1,
          code: '2026-001',
          name: 'é•·å´è‡ªå‹•è»Šé“èˆ—è£…è£œä¿®å·¥äº‹',
          client: 'NEXCOè¥¿æ—¥æœ¬',
          amount: 12500000,
          stage: 'quoted',
          assignee: { id: 1, name: 'ãŸã' },
          closeDate: '2026-02-28',
          tags: ['èˆ—è£…', 'NEXCO']
        },
        {
          id: 2,
          code: '2026-002',
          name: 'ç¦å²¡ç’°çŠ¶ç·šæ©‹æ¢ç‚¹æ¤œ',
          client: 'ç¦å²¡å¸‚é“è·¯ç®¡ç†èª²',
          amount: 8500000,
          stage: 'negotiation',
          assignee: { id: 2, name: 'å±±ç”°' },
          closeDate: '2026-03-15',
          tags: ['æ©‹æ¢', 'ç‚¹æ¤œ']
        },
        {
          id: 3,
          code: '2026-003',
          name: 'åŒ—ä¹å·èˆ—è£…å·¥äº‹',
          client: 'NEXCOä¹å·',
          amount: 25000000,
          stage: 'quoted',
          assignee: { id: 1, name: 'ãŸã' },
          closeDate: '2026-02-15',
          tags: ['èˆ—è£…']
        },
        {
          id: 4,
          code: '2026-004',
          name: 'ç†Šæœ¬çœŒé“æ•´å‚™å·¥äº‹',
          client: 'ç†Šæœ¬çœŒåœŸæœ¨éƒ¨',
          amount: 15000000,
          stage: 'lead',
          assignee: { id: 1, name: 'ãŸã' },
          closeDate: '2026-04-01',
          tags: ['æ•´å‚™']
        },
        {
          id: 5,
          code: '2026-005',
          name: 'ä½è³€ç©ºæ¸¯æ»‘èµ°è·¯è£œä¿®',
          client: 'ä½è³€çœŒç©ºæ¸¯ç®¡ç†èª²',
          amount: 45000000,
          stage: 'won',
          assignee: { id: 2, name: 'å±±ç”°' },
          closeDate: '2026-01-20',
          tags: ['ç©ºæ¸¯', 'ç‰¹æ®Š']
        },
        {
          id: 6,
          code: '2026-006',
          name: 'å°è¦æ¨¡ä¿®ç¹•å·¥äº‹',
          client: 'æ°‘é–“ä¼æ¥­',
          amount: 15000000,
          stage: 'lost',
          assignee: { id: 3, name: 'ä½è—¤' },
          closeDate: '2026-01-10',
          tags: []
        },
        {
          id: 7,
          code: '2026-007',
          name: 'å¤§åˆ†çœŒé“æ”¹è‰¯å·¥äº‹',
          client: 'å¤§åˆ†çœŒåœŸæœ¨éƒ¨',
          amount: 20000000,
          stage: 'lead',
          assignee: { id: 1, name: 'ãŸã' },
          closeDate: '2026-05-01',
          tags: ['æ”¹è‰¯']
        },
        {
          id: 8,
          code: '2026-008',
          name: 'å®®å´é«˜é€Ÿé“è·¯è£œä¿®',
          client: 'NEXCOä¹å·',
          amount: 18000000,
          stage: 'negotiation',
          assignee: { id: 2, name: 'å±±ç”°' },
          closeDate: '2026-03-30',
          tags: ['èˆ—è£…']
        },
        {
          id: 9,
          code: '2026-009',
          name: 'é¹¿å…å³¶æ¸¯æ¹¾å·¥äº‹',
          client: 'é¹¿å…å³¶çœŒæ¸¯æ¹¾å±€',
          amount: 32000000,
          stage: 'quoted',
          assignee: { id: 1, name: 'ãŸã' },
          closeDate: '2026-02-28',
          tags: ['æ¸¯æ¹¾']
        },
        {
          id: 10,
          code: '2026-010',
          name: 'é•·å´å¸‚é“èˆ—è£…',
          client: 'é•·å´å¸‚',
          amount: 9000000,
          stage: 'negotiation',
          assignee: { id: 3, name: 'ä½è—¤' },
          closeDate: '2026-04-15',
          tags: ['èˆ—è£…']
        },
        {
          id: 11,
          code: '2026-011',
          name: 'ç¦å²¡çœŒé“æ”¹è‰¯',
          client: 'ç¦å²¡çœŒåœŸæœ¨éƒ¨',
          amount: 22000000,
          stage: 'quoted',
          assignee: { id: 1, name: 'ãŸã' },
          closeDate: '2026-03-10',
          tags: ['æ”¹è‰¯']
        },
        {
          id: 12,
          code: '2026-012',
          name: 'ç†Šæœ¬ç©ºæ¸¯é§è»Šå ´',
          client: 'ç†Šæœ¬ç©ºæ¸¯',
          amount: 20000000,
          stage: 'won',
          assignee: { id: 2, name: 'å±±ç”°' },
          closeDate: '2026-01-25',
          tags: ['ç©ºæ¸¯']
        }
      ];
    }

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', () => {
      projects = generateSampleData();
      renderKanban();
      updateSummary();
      setupDragAndDrop();
    });

    // ã‚«ãƒ³ãƒãƒ³æç”»
    function renderKanban() {
      const stages = ['lead', 'negotiation', 'quoted', 'won', 'lost'];

      stages.forEach(stage => {
        const column = document.getElementById(stage + 'Column');
        const stageProjects = projects.filter(p => p.stage === stage);

        if (stageProjects.length === 0) {
          column.innerHTML = '<div class="empty-column">æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
          column.innerHTML = stageProjects.map(p => createCard(p)).join('');
        }

        // ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°
        document.getElementById(stage + 'Count').textContent = stageProjects.length;
        const totalAmount = stageProjects.reduce((sum, p) => sum + p.amount, 0);
        document.getElementById(stage + 'Amount').textContent = formatAmount(totalAmount);
      });
    }

    // ã‚«ãƒ¼ãƒ‰ä½œæˆ
    function createCard(project) {
      const probability = stageProbability[project.stage];
      const forecast = project.amount * (probability / 100);

      return `
        <div class="kanban-card" draggable="true" data-id="${project.id}">
          <div class="card-header">
            <span class="card-code">${escapeHtml(project.code)}</span>
            <span class="card-probability">${probability}%</span>
          </div>
          <div class="card-title">${escapeHtml(project.name)}</div>
          <div class="card-client">${escapeHtml(project.client)}</div>
          ${project.tags.length > 0 ? `
            <div class="card-tags">
              ${project.tags.map(t => `<span class="card-tag">${escapeHtml(t)}</span>`).join('')}
            </div>
          ` : ''}
          <div class="card-amount">${formatAmount(project.amount)}</div>
          <div class="card-forecast">äºˆæ¸¬: ${formatAmount(forecast)}</div>
          <div class="card-footer">
            <div class="card-assignee">
              <div class="assignee-avatar">${escapeHtml(project.assignee.name.charAt(0))}</div>
              <span>${escapeHtml(project.assignee.name)}</span>
            </div>
            <span class="card-date">${project.closeDate || '-'}</span>
          </div>
        </div>
      `;
    }

    // ã‚µãƒãƒªãƒ¼æ›´æ–°
    function updateSummary() {
      const totalCount = projects.length;
      const totalAmount = projects.reduce((sum, p) => sum + p.amount, 0);
      const forecastAmount = projects.reduce((sum, p) => {
        const prob = stageProbability[p.stage];
        return sum + (p.amount * prob / 100);
      }, 0);

      document.getElementById('totalCount').textContent = totalCount + 'ä»¶';
      document.getElementById('totalAmount').textContent = formatAmount(totalAmount);
      document.getElementById('forecastAmount').textContent = formatAmount(forecastAmount);
    }

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
    function setupDragAndDrop() {
      // ã‚«ãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.column-body').forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
      });

      // å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('kanban-card')) {
          draggedCard = e.target;
          e.target.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        }
      });

      document.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('kanban-card')) {
          e.target.classList.remove('dragging');
          document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('active'));
          draggedCard = null;
        }
      });
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('active');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('active');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('active');

      if (!draggedCard) return;

      const projectId = parseInt(draggedCard.dataset.id);
      const newStage = e.currentTarget.closest('.kanban-column').dataset.stage;

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æ›´æ–°
      const project = projects.find(p => p.id === projectId);
      if (project && project.stage !== newStage) {
        project.stage = newStage;
        renderKanban();
        updateSummary();
        showBanner('ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
    function openNewModal() {
      document.getElementById('projectForm').reset();
      document.getElementById('newModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('newModal').classList.remove('show');
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜
    function saveProject(e) {
      e.preventDefault();

      const newProject = {
        id: projects.length + 1,
        code: '2026-' + String(projects.length + 1).padStart(3, '0'),
        name: document.getElementById('projectName').value,
        client: document.getElementById('clientName').value,
        amount: parseInt(document.getElementById('amount').value) || 0,
        stage: document.getElementById('stage').value,
        assignee: { id: 1, name: 'ãŸã' },
        closeDate: document.getElementById('closeDate').value,
        tags: []
      };

      projects.push(newProject);
      renderKanban();
      updateSummary();
      closeModal();
      showBanner('æ¡ˆä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
    }

    // ä¸€è¦§è¡¨ç¤ºåˆ‡æ›¿
    function switchToList() {
      alert('ä¸€è¦§è¡¨ç¤ºã¯åˆ¥é€”å®Ÿè£…äºˆå®šã§ã™');
    }

    // ãƒãƒŠãƒ¼è¡¨ç¤º
    function showBanner(message) {
      const banner = document.getElementById('banner');
      banner.textContent = 'âœ… ' + message;
      banner.classList.add('show');
      setTimeout(() => {
        banner.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
